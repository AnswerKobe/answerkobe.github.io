<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ | Iverson's blog</title>
<meta name=keywords content="Flutter,Android"><meta name=description content="Render Tree çš„åˆ›å»ºè¿‡ç¨‹ RenderObject çš„ç±»å‹ æˆ‘ä»¬çŸ¥é“ Element ä¸»è¦åˆ†ä¸ºè´Ÿè´£æ¸²æŸ“çš„ RenderObjectElement å’Œè´Ÿè´£ç»„åˆçš„ ComponentElement ä¸¤å¤§ç±»ï¼Œè€Œåˆ›å»º RenderObject èŠ‚ç‚¹çš„æ˜¯å‰è€… mount() æ–¹æ³•ä¸­è°ƒç”¨çš„ RenderObjectWidget.createRenderObject() æ–¹æ³•ã€‚
è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å­ç±»å®ç°ï¼Œå¯¹äºä¸åŒçš„å¸ƒå±€çš„ Widget åˆ›å»ºçš„ RenderObject ç±»å‹ä¹Ÿä¸ä¸€æ ·ï¼Œåœ¨ Render Tree ä¸­æœ€ä¸»è¦çš„æœ‰ä¸¤ç§ RenderObjectï¼š
é¦–å…ˆæ˜¯åœ¨ RenderObject æ³¨é‡Šè¯´æ˜ä¸­å¤§é‡æåˆ°äº†ä¸€ä¸ªç±» RenderBoxï¼Œå®ƒæ˜¯å¤§éƒ¨åˆ†çš„ RenderObjectWidget æ‰€å¯¹åº”çš„ RenderObject çš„æŠ½è±¡ç±» /// A render object in a 2D Cartesian coordinate system. /// ä¸€ä¸ªåœ¨ 2D åæ ‡ç³»ä¸­çš„æ¸²æŸ“å¯¹è±¡ abstract class RenderBox extends RenderObject ä»¥åŠ Render Tree çš„æ ¹èŠ‚ç‚¹ RenderView /// The root of the render tree. /// Render Tree çš„æ ¹èŠ‚ç‚¹ï¼Œå¤„ç†æ¸²æŸ“ç®¡é“çš„å¼•å¯¼å’Œæ¸²æŸ“æ ‘çš„è¾“å‡º /// å®ƒæœ‰ä¸€ä¸ªå¡«å……æ•´ä¸ªè¾“å‡ºè¡¨é¢çš„ RenderBox ç±»å‹çš„å”¯ä¸€å­èŠ‚ç‚¹ class RenderView extends RenderObject with RenderObjectWithChildMixin<RenderBox> å…¶ä»–çš„ç±»å‹çš„ RenderObject åŸºæœ¬æ˜¯ä¸ºäº†ç‰¹å®šå¸ƒå±€ï¼ˆå¦‚æ»‘åŠ¨ã€åˆ—è¡¨ï¼‰çš„å®ç°ï¼Œä½†å¤§éƒ¨åˆ†éƒ½ç›´æ¥æˆ–é—´æ¥é›†æˆè‡ª RenderBoxã€‚"><meta name=author content><link rel=canonical href=http://answerkobe.github.io/posts/analysis-flutter-paint-process/><link crossorigin=anonymous href=/assets/css/stylesheet.81e9c84b86321fe9cfdf9f01a2f8060920d09e0fec45cb91f131cfed0284007e.css integrity="sha256-genIS4YyH+nP358BovgGCSDQng/sRcuR8THP7QKEAH4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=http://answerkobe.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://answerkobe.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://answerkobe.github.io/favicon-32x32.png><link rel=apple-touch-icon href=http://answerkobe.github.io/apple-touch-icon.png><link rel=mask-icon href=http://answerkobe.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y4112QEXZJ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Y4112QEXZJ",{anonymize_ip:!1})}</script><meta property="og:title" content="Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ"><meta property="og:description" content="Render Tree çš„åˆ›å»ºè¿‡ç¨‹ RenderObject çš„ç±»å‹ æˆ‘ä»¬çŸ¥é“ Element ä¸»è¦åˆ†ä¸ºè´Ÿè´£æ¸²æŸ“çš„ RenderObjectElement å’Œè´Ÿè´£ç»„åˆçš„ ComponentElement ä¸¤å¤§ç±»ï¼Œè€Œåˆ›å»º RenderObject èŠ‚ç‚¹çš„æ˜¯å‰è€… mount() æ–¹æ³•ä¸­è°ƒç”¨çš„ RenderObjectWidget.createRenderObject() æ–¹æ³•ã€‚
è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å­ç±»å®ç°ï¼Œå¯¹äºä¸åŒçš„å¸ƒå±€çš„ Widget åˆ›å»ºçš„ RenderObject ç±»å‹ä¹Ÿä¸ä¸€æ ·ï¼Œåœ¨ Render Tree ä¸­æœ€ä¸»è¦çš„æœ‰ä¸¤ç§ RenderObjectï¼š
é¦–å…ˆæ˜¯åœ¨ RenderObject æ³¨é‡Šè¯´æ˜ä¸­å¤§é‡æåˆ°äº†ä¸€ä¸ªç±» RenderBoxï¼Œå®ƒæ˜¯å¤§éƒ¨åˆ†çš„ RenderObjectWidget æ‰€å¯¹åº”çš„ RenderObject çš„æŠ½è±¡ç±» /// A render object in a 2D Cartesian coordinate system. /// ä¸€ä¸ªåœ¨ 2D åæ ‡ç³»ä¸­çš„æ¸²æŸ“å¯¹è±¡ abstract class RenderBox extends RenderObject ä»¥åŠ Render Tree çš„æ ¹èŠ‚ç‚¹ RenderView /// The root of the render tree. /// Render Tree çš„æ ¹èŠ‚ç‚¹ï¼Œå¤„ç†æ¸²æŸ“ç®¡é“çš„å¼•å¯¼å’Œæ¸²æŸ“æ ‘çš„è¾“å‡º /// å®ƒæœ‰ä¸€ä¸ªå¡«å……æ•´ä¸ªè¾“å‡ºè¡¨é¢çš„ RenderBox ç±»å‹çš„å”¯ä¸€å­èŠ‚ç‚¹ class RenderView extends RenderObject with RenderObjectWithChildMixin<RenderBox> å…¶ä»–çš„ç±»å‹çš„ RenderObject åŸºæœ¬æ˜¯ä¸ºäº†ç‰¹å®šå¸ƒå±€ï¼ˆå¦‚æ»‘åŠ¨ã€åˆ—è¡¨ï¼‰çš„å®ç°ï¼Œä½†å¤§éƒ¨åˆ†éƒ½ç›´æ¥æˆ–é—´æ¥é›†æˆè‡ª RenderBoxã€‚"><meta property="og:type" content="article"><meta property="og:url" content="http://answerkobe.github.io/posts/analysis-flutter-paint-process/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-11T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-11T00:00:00+00:00"><meta property="og:site_name" content="Iverson"><meta name=twitter:card content="summary"><meta name=twitter:title content="Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ"><meta name=twitter:description content="Render Tree çš„åˆ›å»ºè¿‡ç¨‹ RenderObject çš„ç±»å‹ æˆ‘ä»¬çŸ¥é“ Element ä¸»è¦åˆ†ä¸ºè´Ÿè´£æ¸²æŸ“çš„ RenderObjectElement å’Œè´Ÿè´£ç»„åˆçš„ ComponentElement ä¸¤å¤§ç±»ï¼Œè€Œåˆ›å»º RenderObject èŠ‚ç‚¹çš„æ˜¯å‰è€… mount() æ–¹æ³•ä¸­è°ƒç”¨çš„ RenderObjectWidget.createRenderObject() æ–¹æ³•ã€‚
è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å­ç±»å®ç°ï¼Œå¯¹äºä¸åŒçš„å¸ƒå±€çš„ Widget åˆ›å»ºçš„ RenderObject ç±»å‹ä¹Ÿä¸ä¸€æ ·ï¼Œåœ¨ Render Tree ä¸­æœ€ä¸»è¦çš„æœ‰ä¸¤ç§ RenderObjectï¼š
é¦–å…ˆæ˜¯åœ¨ RenderObject æ³¨é‡Šè¯´æ˜ä¸­å¤§é‡æåˆ°äº†ä¸€ä¸ªç±» RenderBoxï¼Œå®ƒæ˜¯å¤§éƒ¨åˆ†çš„ RenderObjectWidget æ‰€å¯¹åº”çš„ RenderObject çš„æŠ½è±¡ç±» /// A render object in a 2D Cartesian coordinate system. /// ä¸€ä¸ªåœ¨ 2D åæ ‡ç³»ä¸­çš„æ¸²æŸ“å¯¹è±¡ abstract class RenderBox extends RenderObject ä»¥åŠ Render Tree çš„æ ¹èŠ‚ç‚¹ RenderView /// The root of the render tree. /// Render Tree çš„æ ¹èŠ‚ç‚¹ï¼Œå¤„ç†æ¸²æŸ“ç®¡é“çš„å¼•å¯¼å’Œæ¸²æŸ“æ ‘çš„è¾“å‡º /// å®ƒæœ‰ä¸€ä¸ªå¡«å……æ•´ä¸ªè¾“å‡ºè¡¨é¢çš„ RenderBox ç±»å‹çš„å”¯ä¸€å­èŠ‚ç‚¹ class RenderView extends RenderObject with RenderObjectWithChildMixin<RenderBox> å…¶ä»–çš„ç±»å‹çš„ RenderObject åŸºæœ¬æ˜¯ä¸ºäº†ç‰¹å®šå¸ƒå±€ï¼ˆå¦‚æ»‘åŠ¨ã€åˆ—è¡¨ï¼‰çš„å®ç°ï¼Œä½†å¤§éƒ¨åˆ†éƒ½ç›´æ¥æˆ–é—´æ¥é›†æˆè‡ª RenderBoxã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://answerkobe.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ","item":"http://answerkobe.github.io/posts/analysis-flutter-paint-process/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ","name":"Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ","description":"Render Tree çš„åˆ›å»ºè¿‡ç¨‹ RenderObject çš„ç±»å‹ æˆ‘ä»¬çŸ¥é“ Element ä¸»è¦åˆ†ä¸ºè´Ÿè´£æ¸²æŸ“çš„ RenderObjectElement å’Œè´Ÿè´£ç»„åˆçš„ ComponentElement ä¸¤å¤§ç±»ï¼Œè€Œåˆ›å»º RenderObject èŠ‚ç‚¹çš„æ˜¯å‰è€… mount() æ–¹æ³•ä¸­è°ƒç”¨çš„ RenderObjectWidget.createRenderObject() æ–¹æ³•ã€‚\nè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å­ç±»å®ç°ï¼Œå¯¹äºä¸åŒçš„å¸ƒå±€çš„ Widget åˆ›å»ºçš„ RenderObject ç±»å‹ä¹Ÿä¸ä¸€æ ·ï¼Œåœ¨ Render Tree ä¸­æœ€ä¸»è¦çš„æœ‰ä¸¤ç§ RenderObjectï¼š\né¦–å…ˆæ˜¯åœ¨ RenderObject æ³¨é‡Šè¯´æ˜ä¸­å¤§é‡æåˆ°äº†ä¸€ä¸ªç±» RenderBoxï¼Œå®ƒæ˜¯å¤§éƒ¨åˆ†çš„ RenderObjectWidget æ‰€å¯¹åº”çš„ RenderObject çš„æŠ½è±¡ç±» /// A render object in a 2D Cartesian coordinate system. /// ä¸€ä¸ªåœ¨ 2D åæ ‡ç³»ä¸­çš„æ¸²æŸ“å¯¹è±¡ abstract class RenderBox extends RenderObject ä»¥åŠ Render Tree çš„æ ¹èŠ‚ç‚¹ RenderView /// The root of the render tree. /// Render Tree çš„æ ¹èŠ‚ç‚¹ï¼Œå¤„ç†æ¸²æŸ“ç®¡é“çš„å¼•å¯¼å’Œæ¸²æŸ“æ ‘çš„è¾“å‡º /// å®ƒæœ‰ä¸€ä¸ªå¡«å……æ•´ä¸ªè¾“å‡ºè¡¨é¢çš„ RenderBox ç±»å‹çš„å”¯ä¸€å­èŠ‚ç‚¹ class RenderView extends RenderObject with RenderObjectWithChildMixin\u0026lt;RenderBox\u0026gt; å…¶ä»–çš„ç±»å‹çš„ RenderObject åŸºæœ¬æ˜¯ä¸ºäº†ç‰¹å®šå¸ƒå±€ï¼ˆå¦‚æ»‘åŠ¨ã€åˆ—è¡¨ï¼‰çš„å®ç°ï¼Œä½†å¤§éƒ¨åˆ†éƒ½ç›´æ¥æˆ–é—´æ¥é›†æˆè‡ª RenderBoxã€‚","keywords":["Flutter","Android"],"articleBody":"Render Tree çš„åˆ›å»ºè¿‡ç¨‹ RenderObject çš„ç±»å‹ æˆ‘ä»¬çŸ¥é“ Element ä¸»è¦åˆ†ä¸ºè´Ÿè´£æ¸²æŸ“çš„ RenderObjectElement å’Œè´Ÿè´£ç»„åˆçš„ ComponentElement ä¸¤å¤§ç±»ï¼Œè€Œåˆ›å»º RenderObject èŠ‚ç‚¹çš„æ˜¯å‰è€… mount() æ–¹æ³•ä¸­è°ƒç”¨çš„ RenderObjectWidget.createRenderObject() æ–¹æ³•ã€‚\nè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å­ç±»å®ç°ï¼Œå¯¹äºä¸åŒçš„å¸ƒå±€çš„ Widget åˆ›å»ºçš„ RenderObject ç±»å‹ä¹Ÿä¸ä¸€æ ·ï¼Œåœ¨ Render Tree ä¸­æœ€ä¸»è¦çš„æœ‰ä¸¤ç§ RenderObjectï¼š\né¦–å…ˆæ˜¯åœ¨ RenderObject æ³¨é‡Šè¯´æ˜ä¸­å¤§é‡æåˆ°äº†ä¸€ä¸ªç±» RenderBoxï¼Œå®ƒæ˜¯å¤§éƒ¨åˆ†çš„ RenderObjectWidget æ‰€å¯¹åº”çš„ RenderObject çš„æŠ½è±¡ç±» /// A render object in a 2D Cartesian coordinate system. /// ä¸€ä¸ªåœ¨ 2D åæ ‡ç³»ä¸­çš„æ¸²æŸ“å¯¹è±¡ abstract class RenderBox extends RenderObject ä»¥åŠ Render Tree çš„æ ¹èŠ‚ç‚¹ RenderView /// The root of the render tree. /// Render Tree çš„æ ¹èŠ‚ç‚¹ï¼Œå¤„ç†æ¸²æŸ“ç®¡é“çš„å¼•å¯¼å’Œæ¸²æŸ“æ ‘çš„è¾“å‡º /// å®ƒæœ‰ä¸€ä¸ªå¡«å……æ•´ä¸ªè¾“å‡ºè¡¨é¢çš„ RenderBox ç±»å‹çš„å”¯ä¸€å­èŠ‚ç‚¹ class RenderView extends RenderObject with RenderObjectWithChildMixin\u003cRenderBox\u003e å…¶ä»–çš„ç±»å‹çš„ RenderObject åŸºæœ¬æ˜¯ä¸ºäº†ç‰¹å®šå¸ƒå±€ï¼ˆå¦‚æ»‘åŠ¨ã€åˆ—è¡¨ï¼‰çš„å®ç°ï¼Œä½†å¤§éƒ¨åˆ†éƒ½ç›´æ¥æˆ–é—´æ¥é›†æˆè‡ª RenderBoxã€‚\né€šå¸¸ä¸€ä¸ª RenderBox åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼ˆå› ä¸ºå®ƒåªæœ‰ä¸€ä¸ª child å±æ€§ï¼‰ï¼Œè¿™ä½¿å¾—å®ƒæ•´ä½“æ›´åƒæ˜¯é“¾è¡¨ã€‚ Flutter æä¾›äº† ContainerRenderObjectMixin ç”¨æ¥ç»™é‚£äº›éœ€è¦å­˜å‚¨å¤šä¸ªå­èŠ‚ç‚¹çš„ RenderBox è¿›è¡Œæ‰©å±•ï¼Œå¤šä¸ªå­èŠ‚ç‚¹çš„ç»„ç»‡æ–¹å¼ä¹Ÿæ˜¯é‡‡ç”¨é“¾è¡¨æ¥è¿æ¥å­˜å‚¨ï¼Œä¸‹é¢åˆ—å‡ºå¸¸è§çš„ä¸¤ç§ï¼š\nRenderStack å®ç°äº†å †æ ˆå¸ƒå±€ç®—æ³• RenderFlex å®ç°äº† Flex å¸ƒå±€ç®—æ³•ï¼ŒColumn å’Œ Row éƒ½æ˜¯å±äº Flex çš„å˜ä½“ RenderView å¦‚ä½•åˆ›å»º æ—¢ç„¶ Render Tree çš„æ ¹èŠ‚ç‚¹æ˜¯ RenderViewï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ RenderView æ˜¯åœ¨å“ªè¢«åˆ›å»ºçš„ã€‚\né€šè¿‡ IDE çš„å…¨å±€æœç´¢æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„åˆ›å»ºå¼•ç”¨æ˜¯åœ¨ RendererBinding ä¸­ã€‚\n/// Flutter å¼•æ“å’Œ Render Tree ä¹‹é—´çš„ä¸€ä¸ªç»‘å®šå™¨ mixin RendererBinding on BindingBase, ServicesBinding, SchedulerBinding, GestureBinding, SemanticsBinding, HitTestable è¿™ä¸ªç±»å»ºç«‹äº† Flutter Engine å’Œ Render Tree ä¹‹é—´çš„å…³è”ï¼Œæ³¨é‡Šä¸­ä»‹ç»ï¼Œå½“ Binding è¢«åˆ›å»ºçš„æ—¶å€™å°±ä¼šæ‰§è¡Œ initInstances() è¿›è¡Œåˆå§‹åŒ–å¹¶åˆ›å»º RenderViewã€‚\n/// RendererBinding @override void initInstances() { // ... çœç•¥äº† PipelineOwner åˆ›å»ºå’Œ window åˆå§‹åŒ–ä»£ç  // åˆ›å»º RenderView initRenderView(); } /// Called automatically when the binding is created. void initRenderView() { // ... renderView = RenderView( configuration: createViewConfiguration(), window: window); // åˆå§‹åŒ– RenderView renderView.prepareInitialFrame(); } æˆ‘ä»¬å›åˆ° Flutter App å¯åŠ¨æ—¶è°ƒç”¨çš„å‡½æ•° runAppã€‚\nrunApp ä¼šåˆ›å»º WidgetsFlutterBindingï¼Œå¹¶æ‰§è¡Œ ensureInitialized() æ–¹æ³•ã€‚\nvoid runApp(Widget app) { WidgetsFlutterBinding.ensureInitialized() //åˆå§‹åŒ– ..scheduleAttachRootWidget(app) // åˆ›å»ºå…¶ä»–ä¸¤æ£µæ ‘çš„æ ¹èŠ‚ç‚¹ ..scheduleWarmUpFrame(); } è€Œè¿™ä¸ª WidgetsFlutterBinding å®é™…ä¸Šç”± 7 ä¸ª mixin Binding ç»„åˆæˆï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº† RendererBindingï¼Œè€Œè°ƒç”¨è¿™å‡ ä¸ª mixin Binding çš„ initInstances() éƒ½æ˜¯äº¤ç»™çˆ¶ç±» BindingBase åœ¨æ„é€ æ–¹æ³•ä¸­æ‰§è¡Œã€‚\nè¿™ç§é‡‡ç”¨ mixin ç»„åˆ Binding çš„è®¾è®¡å¯ä»¥æ–¹ä¾¿åç»­æ¥å…¥æ–°çš„ Bindingã€‚\nclass WidgetsFlutterBinding extends BindingBase with GestureBinding, SchedulerBinding, ServicesBinding, PaintingBinding, SemanticsBinding, RendererBinding, WidgetsBinding { static WidgetsBinding ensureInitialized() { if (WidgetsBinding.instance == null) WidgetsFlutterBinding(); return WidgetsBinding.instance!; } } abstract class BindingBase { /// Default abstract constructor for bindings. /// /// First calls [initInstances] to have bindings initialize their /// instance pointers and other state, then calls /// [initServiceExtensions] to have bindings initialize their /// observatory service extensions, if any. BindingBase() { initInstances(); initServiceExtensions(); developer.postEvent('Flutter.FrameworkInitialization', \u003cString, String\u003e{}); developer.Timeline.finishSync(); } } ä¸‰æ£µæ ‘çš„åˆå§‹åŒ–å…³è” åœ¨ensureInitialized() æ–¹æ³•æ‰§è¡Œå®Œæˆå¾—åˆ° Render Tree æ ¹èŠ‚ç‚¹ä¹‹åï¼Œå°±æ˜¯è°ƒç”¨ scheduleAttachRootWidget() åˆ›å»ºå…¶ä»–ä¸¤æ£µæ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œç„¶åå’Œ Render Tree è¿›è¡Œå…³è”ã€‚\n@protected void scheduleAttachRootWidget(Widget rootWidget) { Timer.run(() { attachRootWidget(rootWidget); }); } void attachRootWidget(Widget rootWidget) { final bool isBootstrapFrame = renderViewElement == null; _readyToProduceFrames = true; _renderViewElement = RenderObjectToWidgetAdapter\u003cRenderBox\u003e( container: renderView, debugShortDescription: '[root]', child: rootWidget, ).attachToRenderTree( buildOwner!, renderViewElement as RenderObjectToWidgetElement\u003cRenderBox\u003e? ); if (isBootstrapFrame) { SchedulerBinding.instance!.ensureVisualUpdate(); } } åœ¨è¿™é‡ŒattachRootWidget() åˆ›å»ºäº† RenderObjectToWidgetAdapterï¼Œå®ƒçš„æœ¬è´¨å…¶å®æ˜¯ RenderObjectWidgetï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå£°æ˜äº†å¯¹åº”çš„ Render Tree çš„èŠ‚ç‚¹ç±»å‹ä¸º RenderBoxï¼Œå¹¶ä¸”æŒ‡å®šäº†è¯¥ RenderBox çš„çˆ¶èŠ‚ç‚¹æ˜¯ RenderViewã€‚\næœ€åè°ƒç”¨ attachToRenderTree() å°† RenderObjectToWidgetAdapter è½¬åŒ–ä¸º RootRenderObjectElement å¹¶å’Œ Render Tree è¿›è¡Œç»‘å®šã€‚\nPipelineOwner æ¸²æŸ“ç®¡é“ç®¡ç† ç›®å‰çš„ Render Tree åªæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå¹¶æ²¡æœ‰æ¸²æŸ“æ“ä½œã€‚å› æ­¤æˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹ä» Render Tree åˆ°ç•Œé¢æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„è¿‡ç¨‹ã€‚\nåˆšåˆšæåˆ°äº† RenderBinding å»ºç«‹äº† Flutter Engine å’Œ Render Tree ä¹‹é—´çš„å…³è”ï¼Œåœ¨åˆ›å»º RenderView çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°å®ƒè¿˜åˆ›å»ºäº†ä¸€ä¸ª PipelineOwner çš„å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨è®¾ç½® renderView æ—¶è¿˜å°† RenderView èµ‹å€¼ç»™äº†å®ƒçš„ rootNodeã€‚\n/// RendererBinding @override void initInstances() { _pipelineOwner = PipelineOwner( onNeedVisualUpdate: ensureVisualUpdate, onSemanticsOwnerCreated: _handleSemanticsOwnerCreated, onSemanticsOwnerDisposed: _handleSemanticsOwnerDisposed, ); } set renderView(RenderView value) { _pipelineOwner.rootNode = value; } PipelineOwner å…¶å®æ¸²æŸ“ç®¡é“çš„ç®¡ç†è€…ï¼Œå®ƒåœ¨æ¸²æŸ“æµç¨‹ä¸­æœ‰ 3 ä¸ªä¸»è¦çš„æ–¹æ³•ï¼š\nflushLayout æ›´æ–°æ‰€æœ‰è„èŠ‚ç‚¹åˆ—è¡¨çš„å¸ƒå±€ä¿¡æ¯ flushCompositionBits å¯¹é‡æ–°è®¡ç®— needsCompositing çš„èŠ‚ç‚¹è¿›è¡Œæ›´æ–° flushPaint é‡ç»˜æ‰€æœ‰è„èŠ‚ç‚¹ è¿™ 3 ä¸ªæ–¹æ³•é€šå¸¸æ˜¯æŒ‰é¡ºåºä¸€èµ·ä½¿ç”¨çš„ï¼ŒRenderBiding ä¼šåœ¨ drawFrame() æ–¹æ³•ä¸­è°ƒç”¨è¿™ 3 ä¸ªæ–¹æ³•\n/// RenderBiding @protected void drawFrame() { assert(renderView != null); pipelineOwner.flushLayout(); pipelineOwner.flushCompositingBits(); pipelineOwner.flushPaint(); if (sendFramesToEngine) { renderView.compositeFrame(); // this sends the bits to the GPU pipelineOwner.flushSemantics(); // this also sends the semantics to the OS. _firstFrameSent = true; } } é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ç ”ç©¶ä¸€ä¸‹è¿™ 3 ä¸ªæ–¹æ³•åˆ†åˆ«åšäº†ä»€ä¹ˆã€‚\nflushLayout æˆ‘ä»¬çŸ¥é“å½“ RenderObject æœ‰ä¸¤ä¸ªæ ‡è¯†ï¼š\n_needsLayout ç”¨äºæ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–° Layout _needsPaint ç”¨äºæ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–°ç»˜åˆ¶ è¿™ä¸¤ä¸ªå±æ€§æ˜¯ä¿è¯ Render Tree å±€éƒ¨é‡ç»˜çš„å…³é”®å±æ€§ã€‚\nå½“æŸä¸ªèŠ‚ç‚¹éœ€è¦æ›´æ–°å¸ƒå±€ä¿¡æ¯æ—¶ï¼Œä¼šè°ƒç”¨ markNeedsLayout() æ¥é‡ç½® _needsLayoutï¼Œä½†åªè¿™ä¸ªè¿‡ç¨‹è¿˜ä¼šå°†å½“å‰èŠ‚ç‚¹æ·»åŠ åˆ° PipelineOwner çš„ _nodesNeedingLayout ä¸­ï¼ˆmarkNeedsPaint åˆ™ä¼šæ·»åŠ åˆ° _nodesNeedingPaintï¼‰ã€‚\n// ä»…ä¿ç•™ä¸»è¦ä»£ç  void markNeedsLayout() { _needsLayout = true; if (owner != null) { owner!._nodesNeedingLayout.add(this); owner!.requestVisualUpdate(); } } flushLayout() ä¼šå°†æ·±åº¦éå†è¿™äº›èŠ‚ç‚¹ï¼Œè°ƒç”¨ RenderObject çš„ _layoutWithoutResize() æ–¹æ³•æ¥é‡æ–° Layoutï¼Œæœ€åå°† _needsLayout ç½®ä¸º false å¹¶è°ƒç”¨ markNeedsPaint() è®©è¯¥èŠ‚ç‚¹éœ€è¦é‡æ–°ç»˜åˆ¶ã€‚\n/// PipelineOwner void flushLayout() { // åªä¿ç•™ä¸»è¦é€»è¾‘ while (_nodesNeedingLayout.isNotEmpty) { final List\u003cRenderObject\u003e dirtyNodes = _nodesNeedingLayout; _nodesNeedingLayout = \u003cRenderObject\u003e[]; // æ·±åº¦éå† for (RenderObject node in dirtyNodes..sort( (RenderObject a, RenderObject b) =\u003e a.depth - b.depth) ) { if (node._needsLayout \u0026\u0026 node.owner == this) node._layoutWithoutResize(); } } } /// RenderObject @pragma('vm:notify-debugger-on-exception') void _layoutWithoutResize() { try { performLayout(); // å¸ƒå±€æµ‹é‡ markNeedsSemanticsUpdate(); } catch (e, stack) { _debugReportException('performLayout', e, stack); } _needsLayout = false; markNeedsPaint(); // è®©èŠ‚ç‚¹éœ€è¦é‡æ–°ç»˜åˆ¶ } Layout æ˜¯é€šè¿‡ performLayout() æ–¹æ³•å®Œæˆçš„ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ RenderObject é¢„ç•™ç»™å­ç±»å®ç°è‡ªèº« Layout é€»è¾‘çš„æŠ½è±¡æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨ RenderView ä¸­çš„å®ç°å¦‚ä¸‹\n/// RenderView @override void performLayout() { // RenderView éœ€è¦å æ»¡æ•´ä¸ªå±å¹• // ä½¿ç”¨ ViewConfiguration çš„ size _size = configuration.size; if (child != null) // è®©å­èŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹çš„å¸ƒå±€çº¦æŸä¸‹è¿›è¡Œ Layout child!.layout(BoxConstraints.tight(_size)); } è¦æ³¨æ„çš„æ˜¯ï¼Œè‡ªå®šä¹‰çš„ RenderBox å¦‚æœè¦æ”¾åœ¨èƒ½åŒ…å«å¤šä¸ªå­èŠ‚ç‚¹çš„ RenderBox ä¸­ï¼Œä¾‹å¦‚ RenderFlex å’Œ RenderStackï¼Œé‚£ä¹ˆéœ€è¦é‡å†™ performLayout() æ¥ç¡®å®šå¸ƒå±€å¤§å°ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨å¦å¤–ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨çˆ¶èŠ‚ç‚¹çš„æä¾›çš„çº¦æŸæ¥è°ƒæ•´è‡ªå·±çš„å¤§å°ï¼š\n@override bool get sizedByParent =\u003e true; @override Size computeDryLayout(BoxConstraints constraints) { return constraints.smallest; } è¿™ä¸ªæ–¹å¼åœ¨æˆ‘ä»¬ä¸‹é¢çš„å®éªŒğŸ§ªä¼šç”¨åˆ°ã€‚\nflushCompositingBits åœ¨ flushLayout() æ–¹æ³•åç´§æ¥ç€ä¼šè¢«è°ƒç”¨çš„æ–¹æ³•æ˜¯ flushCompositingBits()ã€‚è¿™ä¸ªæ–¹æ³•ä¼šè¿›è¡Œæ·±åº¦éå†æ›´æ–° _nodesNeedingCompositingBitsUpdate åˆ—è¡¨ä¸­èŠ‚ç‚¹çš„ needsCompositingï¼Œå®ƒä¼šè°ƒç”¨èŠ‚ç‚¹çš„ _updateCompositingBits() æ–¹æ³•å¯¹ RenderObject èŠ‚ç‚¹çš„ä¸€äº›å±æ€§è¿›è¡Œæ›´æ–°ï¼ŒåŒ…æ‹¬ï¼š\n_needsCompositing æ˜¯å¦éœ€è¦åˆæˆ layer _needsCompositingBitsUpdate æ˜¯å¦éœ€è¦æ›´æ–° _needsCompositing /// PipelineOwner void flushCompositingBits() { // åªä¿ç•™ä¸»è¦é€»è¾‘ _nodesNeedingCompositingBitsUpdate.sort( (RenderObject a, RenderObject b) =\u003e a.depth - b.depth); for (final RenderObject node in _nodesNeedingCompositingBitsUpdate) { if (node._needsCompositingBitsUpdate \u0026\u0026 node.owner == this) node._updateCompositingBits(); } _nodesNeedingCompositingBitsUpdate.clear(); if (!kReleaseMode) { Timeline.finishSync(); } } flushPaint flushPaint() æ˜¯ç¬¬ 3 ä¸ªè°ƒç”¨çš„ï¼Œå¯¹ _nodesNeedingPaint ä¸­çš„èŠ‚ç‚¹è¿›è¡Œæ·±åº¦éå†ï¼Œç„¶åè°ƒç”¨èŠ‚ç‚¹çš„ PaintingContext çš„é™æ€æ–¹æ³• repaintCompositedChild() é‡æ–°ç»˜åˆ¶ RenderObject çš„è§†å›¾ã€‚\n/// PipelineOwner void flushPaint() { // åªä¿ç•™ä¸»è¦é€»è¾‘ final List\u003cRenderObject\u003e dirtyNodes = _nodesNeedingPaint; _nodesNeedingPaint = \u003cRenderObject\u003e[]; // Sort the dirty nodes in reverse order (deepest first). for (final RenderObject node in dirtyNodes..sort( (RenderObject a, RenderObject b) =\u003e b.depth - a.depth)) { if (node._needsPaint \u0026\u0026 node.owner == this) { if (node._layerHandle.layer!.attached) { PaintingContext.repaintCompositedChild(node); } else { node._skippedPaintingOnLayer(); } } } } è¯¥æ–¹æ³•ä¸­é€šè¿‡å±‚å±‚è°ƒç”¨æœ€ç»ˆä¼šåˆ°è¾¾ï¼Œä¼ å…¥èŠ‚ç‚¹çš„ paint() æ–¹æ³•ã€‚paint() æ–¹æ³•ä¹Ÿæ˜¯ RenderObject æä¾›ç»™å­ç±»å®ç°ç»˜åˆ¶é€»è¾‘çš„æŠ½è±¡æ–¹æ³•ã€‚åŒæ ·ä»¥ RenderView ä¸ºä¾‹å­ï¼š\n/// RenderView @override void paint(PaintingContext context, Offset offset) { if (child != null) context.paintChild(child!, offset); } ç”±äº RenderView æ˜¯æ•´é¢—æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œå› æ­¤æ²¡æœ‰ä»€ä¹ˆç»˜åˆ¶é€»è¾‘ï¼Œä½†æ‰€æœ‰çš„ RenderObject éƒ½ä¸€æ ·ï¼Œå¦‚æœæœ‰å­èŠ‚ç‚¹éƒ½ä¼šé€šè¿‡ PaintingContext ç»§ç»­è°ƒç”¨å­èŠ‚ç‚¹çš„ paint() æ–¹æ³•å¹¶å°† PaintingContext ä¼ é€’ä¸‹å»ï¼Œç›´åˆ°æ•´é¢—æ ‘çš„èŠ‚ç‚¹éƒ½å®Œæˆç»˜åˆ¶ã€‚\nåœºæ™¯åˆæˆä¸ç•Œé¢åˆ·æ–°æ¸²æŸ“ æˆ‘ä»¬çŸ¥é“ Widget æœ€ç»ˆéƒ½æ˜¯é€šè¿‡ Canvas è¿›è¡Œç»˜åˆ¶çš„ï¼Œå› æ­¤æˆ‘ä»¬ä»¥ä¸€ä¸ªè‡ªå®šä¹‰ View çš„ä¾‹å­æ¥åšåˆ†æã€‚\nåœ¨ ã€ŠFlutter å®æˆ˜Â·ç¬¬äºŒç‰ˆã€‹ è¿™æœ¬ä¹¦ä¸­ï¼Œæ˜¯ä½¿ç”¨ CustomPainter æ¥ç¼–å†™è‡ªå®šä¹‰ Viewï¼Œé€šè¿‡é‡å†™ void paint(Canvas canvas, Size size); æ–¹æ³•æ¥è·å¾—ä¸€ä¸ª Canvas å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥å¾€è¿™ä¸ªæ–¹æ³•çš„æºç ç¿»é˜…ï¼ŒæŸ¥çœ‹è¿™ä¸ª Canvas å¯¹è±¡çš„æ¥æºã€‚\n// custom_paint.dart abstract class CustomPainter extends Listenable /// Provides a canvas on which to draw during the paint phase. /// æä¾›äº†åœ¨ç»˜å›¾é˜¶æ®µè¦è¿›è¡Œç»˜åˆ¶çš„ Canvas class RenderCustomPaint extends RenderProxyBox { void _paintWithPainter(Canvas canvas, Offset offset, CustomPainter painter) { // ... // åœ¨è¿™é‡Œè°ƒç”¨ CustomPainter çš„ paintï¼Œå¹¶æä¾›ä¸€ä¸ª Canvas å¯¹è±¡ painter.paint(canvas, size); } @override void paint(PaintingContext context, Offset offset) { if (_painter != null) { // è¿™é‡Œæä¾› canvas _paintWithPainter(context.canvas, offset, _painter!); _setRasterCacheHints(context); } super.paint(context, offset); if (_foregroundPainter != null) _paintWithPainter(context.canvas, offset, _foregroundPainter!); _setRasterCacheHints(context); } } } åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ View çš„ç»˜åˆ¶æ“ä½œï¼Œæ˜¯ç”± RenderCustomPaint æ‰§è¡Œï¼Œå®ƒçš„æœ¬è´¨å…¶å®æ˜¯ä¸€ä¸ª RenderBoxï¼Œè€Œå…¶ä¸­ä¼ å…¥çš„ Canvas å¯¹è±¡æ˜¯ç”±å®ƒåœ¨ paint() ä¸­çš„ PaintingContext æä¾›çš„ã€‚\nCanvas ä¸ç»˜åˆ¶å­˜å‚¨ åœ¨ PaintingContext ä¸­æ˜¯é‡‡ç”¨æ‡’åŠ è½½çš„æ–¹å¼æ¥åˆ›å»º Canvas å¯¹è±¡ï¼ŒPaintingContext ä¸€èˆ¬åˆ›å»ºäº Render Tree çš„å•ç‹¬å­æ ‘å¼€å§‹ç»˜åˆ¶æ—¶ï¼Œåˆ›å»ºæ—¶ä¼šé™„å¸¦åˆ›å»ºå¦å¤–ä¸¤ä¸ªå¯¹è±¡ï¼š\nPictureLayer å›¾å±‚ PictureRecorder å›¾åƒè®°å½•è€… // object.dart class PaintingContext extends ClipContext { Canvas? _canvas; /// è·å– Canvas å¯¹è±¡ï¼Œ /// å½“ _canvas æ²¡æœ‰åˆ›å»ºæ—¶è°ƒç”¨ [_startRecording] æ–¹æ³•åˆ›å»º @override Canvas get canvas { if (_canvas == null) _startRecording(); assert(_currentLayer != null); return _canvas!; } /// åˆ›å»º Canvas å¯¹è±¡ /// - åˆ›å»º PictureLayer å›¾å±‚å¯¹è±¡ /// - åˆ›å»º PictureRecorder å›¾åƒè®°å½•è€… /// - åˆ›å»º Canvas å¯¹è±¡ /// - å°† PictureLayer æ·»åŠ åˆ° ContainerLayer å®¹å™¨å±‚ void _startRecording() { assert(!_isRecording); _currentLayer = PictureLayer(estimatedBounds); _recorder = ui.PictureRecorder(); _canvas = Canvas(_recorder!); _containerLayer.append(_currentLayer!); } } åˆ›å»º Canvas æ—¶å¿…é¡»ä¼ å…¥ä¸€ä¸ª PictureRecorder å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè®°å½• Canvas çš„ç»˜åˆ¶æ“ä½œï¼Œå½“å®Œæˆè®°å½•æ—¶ï¼Œå¯é€šè¿‡è°ƒç”¨ PictureRecord.endRecording æ¥ç»“æŸè®°å½•ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ª Picture å¯¹è±¡ï¼Œç”±äº Canvas çš„ç»˜åˆ¶æ˜¯ç”± Engine å±‚ä¸­çš„ Skia å¼•æ“æä¾›ï¼Œå› æ­¤ Picture å¯¹è±¡ä¹Ÿæ˜¯å­˜å‚¨åœ¨ Engine å±‚ã€‚\n/// PictureRecorder Picture endRecording() { if (_canvas == null) throw StateError('PictureRecorder did not start recording.'); final Picture picture = Picture._(); _endRecording(picture); _canvas!._recorder = null; _canvas = null; return picture; } void _endRecording(Picture outPicture) native 'PictureRecorder_endRecording'; Layer Tree _startRecording() é™¤äº†åˆ›å»º Canvas å’Œ PictureRecorder å¤–ï¼Œè¿˜åˆ›å»ºäº†ä¸€ä¸ª PictureLayer å¯¹è±¡å¹¶å°†å®ƒåŠ å…¥åˆ°äº† _containerLayer ä¸­ã€‚è¿™ä¸ª _containerLayer å…¶å®æ˜¯ RenderObject ä¸­çš„ä¸€ä¸ª Layerã€‚\nLayer æ˜¯ç”¨äºç¼“å­˜ç»˜å›¾æ“ä½œç»“æœï¼ˆPictureï¼‰çš„å›¾å±‚ï¼Œå›¾å±‚å¯ä»¥æŒ‰ç…§è§„åˆ™è¿›è¡Œæ’åˆ—å¾—åˆ°å›¾åƒã€‚æ¯ä¸ª RenderObject ä¸­ä¼šéƒ½æœ‰ä¸€ä¸ª Layerï¼Œå­˜å‚¨åœ¨ LayerHandle ä¸­ï¼ŒRender Tree æ‰§è¡Œ flushPaint å®Œæˆç»˜åˆ¶åï¼Œä¼šå½¢æˆä¸€é¢— Layer Treeï¼ŒLayer Tree çš„èŠ‚ç‚¹æ•°é‡ä¼šæ¯” Render Tree å°‘ï¼Œå‡ ä¸ª RenderObject èŠ‚ç‚¹åªå¯¹åº”ä¸€ä¸ª Layer èŠ‚ç‚¹ã€‚\nLayer èŠ‚ç‚¹ä¹Ÿæœ‰å¤šç§ï¼Œä½†ç”¨çš„æœ€å¤šçš„æ˜¯ä»¥ä¸‹ä¸¤ç§ï¼š\nä½¿ç”¨ PictureRecorder è®°å½•ç»˜å›¾æ“ä½œçš„èŠ‚ç‚¹ä½¿ç”¨ PictureLayerï¼ŒPictureLayer ä¸å…·æœ‰å­èŠ‚ç‚¹ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„å¶å­èŠ‚ç‚¹ç±»å‹ å½“éœ€è¦å’Œ Layer å­èŠ‚ç‚¹è¿›è¡Œå åŠ æ¥å¾—åˆ°å›¾åƒæ—¶ï¼Œå¯ä½¿ç”¨ ContainerLayerï¼Œå®ƒæä¾›äº† append æ–¹æ³•æ¥è¿æ¥ Layerï¼Œä»¥å½¢æˆä¸€é¢— Layer Treeã€‚ ContainerLayer å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œå®ƒä»¬ä»¥é“¾è¡¨çš„æ–¹å¼è¿æ¥åœ¨ä¸€èµ·ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨ ContainerLayerï¼Œè€Œæ˜¯ä½¿ç”¨å®ƒçš„å­ç±» OffsetLayerã€‚\nä½¿ç”¨ prepareInitialFrame() æ–¹æ³•åˆå§‹åŒ– RenderView åˆ›å»ºçš„ Layer ç±»å‹æ˜¯ TransformLayer ï¼Œå®ƒä¹Ÿæ˜¯ OffsetLayer çš„å­ç±»ã€‚\nå½“åˆ›å»º PaintingContext æ—¶æä¾›çš„ Layer èŠ‚ç‚¹ä¸å±äº OffsetLayer æ—¶ ï¼Œä¼šåˆ›å»ºä¸€ä¸ª OffsetLayer æ¥ä»£æ›¿åŸæœ¬çš„ Layerï¼Œä½œä¸ºå½“å‰å­æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚ PaintingContext åˆ›å»ºæ–°çš„ PictureLayer æ—¶å°†ä¼šä½¿ç”¨ append æ–¹æ³•å°†æ–°çš„ Layer èŠ‚ç‚¹æ·»åŠ åˆ°è¿™ä¸ª OffsetLayer ä¸­ã€‚\n/// PaintingContext static void _repaintCompositedChild( RenderObject child, { bool debugAlsoPaintedParent = false, PaintingContext? childContext, }) { OffsetLayer? childLayer = child._layerHandle.layer as OffsetLayer?; if (childLayer == null) { final OffsetLayer layer = OffsetLayer(); child._layerHandle.layer = childLayer = layer; } else { childLayer.removeAllChildren(); } // åœ¨è¿™é‡Œåˆ›å»º PaintingContext childContext ??= PaintingContext(childLayer, child.paintBounds); child._paintWithContext(childContext, Offset.zero); // å®Œæˆç»˜åˆ¶ç»“æŸè®°å½• childContext.stopRecordingIfNeeded(); } ä¸Šé¢æåˆ°å¦‚æœèŠ‚ç‚¹æœ‰å­©å­ï¼Œä¼šé€šè¿‡ context.paintChild() è®©å­èŠ‚ç‚¹ä¹Ÿè°ƒç”¨ _paintWithContext() æ–¹æ³•å°† PaintingContext å‘ä¸‹ä¼ é€’ï¼Œç»§ç»­æ‰§è¡Œå­èŠ‚ç‚¹çš„ paint() æ–¹æ³•è¿›è¡Œç»˜åˆ¶ã€‚\nå½“ç›®å‰çš„å›¾å±‚ç»˜åˆ¶å®Œæˆæ—¶ï¼Œç»˜åˆ¶å®Œæˆæ—¶ä¼šè°ƒç”¨ stopRecordingIfNeeded() æ¥ç»“æŸè®°å½•ç»˜åˆ¶ï¼Œå¹¶å°† PictureRecord ç”Ÿæˆçš„ Picture å¯¹è±¡ç¼“å­˜åˆ° PictureLayer ä¸­ã€‚\n/// PaintingContext @protected @mustCallSuper void stopRecordingIfNeeded() { if (!_isRecording) return; _currentLayer!.picture = _recorder!.endRecording(); _currentLayer = null; _recorder = null; _canvas = null; } /// PictureLayer set picture(ui.Picture? picture) { markNeedsAddToScene(); _picture?.dispose(); _picture = picture; } èŠ‚ç‚¹çš„ç»˜åˆ¶åˆ†ç¦» Render Tree çš„ç»˜åˆ¶æ˜¯é‡‡ç”¨æ·±åº¦éå†è‡ªé¡¶å‘ä¸‹ç»˜åˆ¶çš„ï¼Œå³å½“å‰èŠ‚ç‚¹ç»˜åˆ¶å®Œè°ƒç”¨å­èŠ‚ç‚¹çš„ç»˜åˆ¶æ–¹æ³•ã€‚\nRenderObject æä¾›äº† isRepaintBoundary å±æ€§æ¥åˆ¤æ–­å½“å‰å­æ ‘æ˜¯å¦éœ€è¦ä¸çˆ¶èŠ‚ç‚¹åˆ†å¼€ç»˜åˆ¶ï¼Œè¯¥å±æ€§é»˜è®¤ä¸º falseï¼Œå¹¶ä¸”æ²¡æœ‰ setter æ¥è¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹ä¸€é¢— Render Tree å¯èƒ½åªä¼šç”Ÿæˆ 2 ä¸ª Layer èŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹çš„ TransformLayer å’Œå­˜å‚¨ç»˜åˆ¶ç»“æœçš„ PictureLayoutï¼‰ã€‚\nä½†å…¶å®æˆ‘ä»¬å¯ä»¥åœ¨ RenderBox çš„å­ç±»é‡å†™è¯¥å±æ€§ï¼Œæˆ–è€…ä½¿ç”¨ RenderRepaintBoundaryï¼ˆå®ƒçš„ isRepaintBoundary è¢«é‡å†™ä¸º trueï¼‰ï¼Œæ¥åˆ†ç¦»çˆ¶å­èŠ‚ç‚¹çš„ç»˜åˆ¶ï¼Œä»è¾¾åˆ°åˆ†å¼€ç»˜åˆ¶ç”Ÿæˆä¸åŒ Layer èŠ‚ç‚¹å½¢æˆä¸€é¢— Layer Treeã€‚\nè¯¥å±æ€§åœ¨ markNeedsPaint()æ–¹æ³•ä¸­ä¹Ÿæœ‰ä½¿ç”¨ï¼Œç›¸å…³æºç å¦‚ä¸‹ï¼š\nvoid markNeedsPaint() { if (_needsPaint) return; _needsPaint = true; markNeedsPaintCout++; if (isRepaintBoundary) { if (owner != null) { owner!._nodesNeedingPaint.add(this); owner!.requestVisualUpdate(); } } else if (parent is RenderObject) { final RenderObject parent = this.parent! as RenderObject; parent.markNeedsPaint(); } } å¦‚æœ isRepaintBoundary ä¸º true åˆ™è¡¨ç¤ºå’Œçˆ¶èŠ‚ç‚¹åˆ†å¼€ç»˜åˆ¶ï¼Œå°†è‡ªå·±æ·»åŠ åˆ° _nodesNeedingPaint åˆ—è¡¨ä¸­ï¼Œåœ¨ä¸‹ä¸€æ¬¡æ›´æ–°æ—¶å°±åªä¼šé‡ç»˜å½“å‰å­æ ‘ï¼Œä¸ä¼šæ±¡æŸ“åˆ°çˆ¶èŠ‚ç‚¹ã€‚ å¦‚æœ isRepaintBoundary ä¸º false åˆ™è°ƒç”¨çˆ¶èŠ‚ç‚¹çš„ markNeedsPaint()æ¥è®©çˆ¶èŠ‚ç‚¹å¤„ç†ï¼Œä¸‹ä¸€æ¬¡æ›´æ–°ç”±çˆ¶èŠ‚ç‚¹é‡ç»˜æ—¶æ‰§è¡Œè‡ªå·±çš„ç»˜åˆ¶æ–¹æ³•è¿›è¡Œé‡ç»˜ã€‚ è€Œåœ¨ç»˜åˆ¶æµç¨‹ä¸­ï¼Œå¦‚æœå­èŠ‚ç‚¹çš„ isRepaintBoundary ä¸º trueï¼Œä»£è¡¨éœ€è¦åˆ†å¼€ç»˜åˆ¶ï¼Œä¼šç»“æŸå½“å‰ PictureRecorder çš„è®°å½•å¹¶å°†ç”Ÿæˆçš„ Picture å­˜åˆ° Layer ä¸­ï¼Œç„¶åå¼€å§‹å­èŠ‚ç‚¹çš„ç»˜åˆ¶ã€‚\nå­èŠ‚ç‚¹ç»˜åˆ¶æ—¶ç”±äº PaintingContext çš„ Layer å·²ç»è¢«è®¾ç½®ä¸º null äº†ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºæ–°çš„ PictureLayer å¹¶æ·»åŠ åˆ°æ ¹ Layer çš„å­èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¦‚æœå­èŠ‚ç‚¹ä¸éœ€è¦é‡æ–°ç»˜åˆ¶ï¼Œå°±ç›´æ¥å°†å­èŠ‚ç‚¹çš„ Layer æ·»åŠ åˆ°æ ¹ Layer çš„å­èŠ‚ç‚¹åˆ—è¡¨ã€‚\nè¿™é‡Œæ·»åŠ æ—¶ä½¿ç”¨çš„ appendLayer() ä¼šå…ˆå°†å½“å‰çš„ Layer èŠ‚ç‚¹ä»åŸæœ¬çš„çˆ¶èŠ‚ç‚¹ä¸­ç§»é™¤ï¼Œå†è¿›è¡Œæ·»åŠ ï¼Œå› æ­¤ä¸ç”¨å½“å¿ƒä¼šå‡ºç°é‡å¤æ·»åŠ çš„æƒ…å†µï¼Œç”±äºå­èŠ‚ç‚¹åˆ—è¡¨çš„æœ¬è´¨æ˜¯é“¾è¡¨ï¼Œè€Œä¸”åˆ›å»ºåæ·»åŠ ä¸å†æ·»åŠ ä¹‹é—´é€šå¸¸ä¸ä¼šæœ‰å…¶å®ƒ Layer èŠ‚ç‚¹ä»‹å…¥ï¼Œå› æ­¤ä¹Ÿä¸éœ€è¦å½“å¿ƒè¯¥æ–¹æ³•æ·»åŠ æ—¶çš„ç§»åŠ¨å’ŒæŸ¥æ‰¾æ•ˆç‡ã€‚\n/// PaintingContext void paintChild(RenderObject child, Offset offset) { if (child.isRepaintBoundary) { stopRecordingIfNeeded(); // ç»“æŸå½“å‰æ ‘çš„ç»˜åˆ¶ _compositeChild(child, offset); } else { child._paintWithContext(this, offset); } } /// çœç•¥äº†å¾ˆå¤šä»£ç  void _compositeChild(RenderObject child, Offset offset) { // Create a layer for our child, and paint the child into it. if (child._needsPaint) { repaintCompositedChild(child, debugAlsoPaintedParent: true); } final OffsetLayer childOffsetLayer = child._layerHandle.layer! as OffsetLayer; childOffsetLayer.offset = offset; appendLayer(childOffsetLayer); } @protected void appendLayer(Layer layer) { layer.remove(); // ä»çˆ¶èŠ‚ç‚¹ä¸­ç§»é™¤å½“å‰èŠ‚ç‚¹ _containerLayer.append(layer); } åœºæ™¯æ¸²æŸ“ æˆ‘ä»¬å›åˆ° RenderBinding çš„ drawFrame() æ–¹æ³•ä¸­ï¼Œçœ‹ä¸€ä¸‹ Render Tree å®Œæˆç»˜åˆ¶åï¼Œæ˜¯å¦‚ä½•æ¸²æŸ“åˆ°ç•Œé¢çš„ã€‚\n/// RenderBiding @protected void drawFrame() { pipelineOwner.flushLayout(); pipelineOwner.flushCompositingBits(); pipelineOwner.flushPaint(); if (sendFramesToEngine) { renderView.compositeFrame(); // this sends the bits to the GPU pipelineOwner.flushSemantics(); // this also sends the semantics to the OS. _firstFrameSent = true; } } /// RenderView void compositeFrame() { final ui.SceneBuilder builder = ui.SceneBuilder(); // å°†å›¾å±‚æ·»åŠ åˆ° scene final ui.Scene scene = layer!.buildScene(builder); // å‘é€ scene ç»™ GPU è¿›è¡Œæ¸²æŸ“ _window.render(scene); scene.dispose(); } /// Layer ui.Scene buildScene(ui.SceneBuilder builder) { updateSubtreeNeedsAddToScene(); addToScene(builder); // æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç° _needsAddToScene = false; final ui.Scene scene = builder.build(); return scene; } å½“éœ€è¦å‘é€å¸§å›¾åƒç»™ GPU æ—¶ï¼Œä¼šè°ƒç”¨ compositeFrame() æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šæ„å»ºä¸€ä¸ª SceneBuilderï¼Œç„¶åé€šè¿‡ ContainerLayer.buildScene() å°† Layer Tree çš„ Picture åˆæˆä¸€ä¸ª Sceneã€‚\nScene å¯ç†è§£ä¸ºåœºæ™¯ï¼Œæ˜¯å­˜å‚¨ GPU ç»˜åˆ¶çš„åƒç´ ä¿¡æ¯çš„å›¾åƒå¯¹è±¡ï¼Œå½“æ·»åŠ çš„æ˜¯ OffsetLayer ä¼šè®¾ç½®å›¾å±‚çš„åç§»é‡ï¼Œå½“æ·»åŠ çš„æ˜¯ ContanierLayer æ—¶ä¼šéå†å­èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ï¼Œå½“æ·»åŠ çš„æ˜¯ PictureLayer ä¼šè°ƒç”¨ native æ–¹æ³•åœ¨ Engine æ·»åŠ  Picture åˆ°å›¾åƒä¸­ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ build æ–¹æ³•æ—¶ä¹Ÿæ˜¯ä» Engine å¾—åˆ° Scene å¯¹è±¡ã€‚\nvoid _addPicture(double dx, double dy, Picture picture, int hints) native 'SceneBuilder_addPicture'; void _build(Scene outScene) native 'SceneBuilder_build'; Layer ä¸­æœ‰ä¸¤ä¸ªå±æ€§ _needsAddToScene å’Œ _subtreeNeedsAddToScene æ¥è¡¨ç¤ºè‡ªå·±å’Œå­æ ‘æ˜¯å¦éœ€è¦è¢«æ·»åŠ åˆ° Scene ä¸­ï¼Œå½“ Layer è¢«è„äº†åˆ™éœ€è¦åˆæˆåˆ° Sceneï¼Œä¸€ä¸ª Layer æˆ–è€…å…¶å­æ ‘è¢«åˆæˆåˆ° Scene åï¼Œå¯¹åº”çš„å±æ€§ä¼šè¢«è®¾ç½®ä¸º falseã€‚\nScene åˆæˆå®Œæˆåï¼Œæ¥ç€è°ƒç”¨ render æ–¹æ³•å°† Scene å‘é€ç»™ GUP æ¸²æŸ“åˆ°ç•Œé¢ä¸Šã€‚\n/// FlutterView void render(Scene scene) =\u003e _render(scene, this); void _render(Scene scene, FlutterView view) native 'PlatformConfiguration_render'; ç•Œé¢åˆ·æ–° ç°åœ¨æˆ‘ä»¬çŸ¥é“ Flutter æ˜¯è°ƒç”¨ drawFrame() æ–¹æ³•ï¼Œæ¥åš Render Tree çš„ç»˜åˆ¶ï¼Œé‚£ä¹ˆ drawFrame() ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢ï¼Ÿæˆ‘ä»¬é˜…è¯»ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šã€‚\n/// This method is called by [handleDrawFrame], which itself is called /// automatically by the engine when it is time to lay out and paint a frame. æ³¨é‡Šä¸­è¯´æ˜ drawFrame() ä¼šåœ¨ Engine éœ€è¦æä¾›ä¸€å¸§æ–°å›¾åƒæ—¶ï¼Œè‡ªåŠ¨è¢« handleDrawFrame() æ–¹æ³•è°ƒç”¨ï¼Œå®é™…ä¸Šåœ¨ RenderBinding åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šæŠŠè¿™ä¸ªæ–¹æ³•æ·»åŠ åˆ° persistentCallbacks å›è°ƒåˆ—è¡¨ä¸­ã€‚\n/// RenderBinding void initInstances() { // window çš„åˆå§‹åŒ–æ—¶ä¼šè®¾ç½®ä¸€äº›çŠ¶æ€æ”¹å˜çš„å›è°ƒ window ..onMetricsChanged = handleMetricsChanged ..onTextScaleFactorChanged = handleTextScaleFactorChanged ..onPlatformBrightnessChanged = handlePlatformBrightnessChanged ..onSemanticsEnabledChanged = _handleSemanticsEnabledChanged ..onSemanticsAction = _handleSemanticsAction; // RenderView åˆå§‹åŒ–åˆ›å»º initRenderView(); // åœ¨è¿™é‡Œæ·»åŠ äº†ä¸€ä¸ªå›è°ƒ addPersistentFrameCallback(_handlePersistentFrameCallback); } void _handlePersistentFrameCallback(Duration timeStamp) { drawFrame(); // åœ¨è¿™ä¸ªå›è°ƒé‡Œè°ƒç”¨å¸§ç»˜åˆ¶ _scheduleMouseTrackerUpdate(); } /// SchedulerBinding /// è¯¥åˆ—è¡¨ä¸­çš„å›è°ƒæ–¹æ³•ä¼šè¢« handleDrawFrame ä¾æ¬¡æ‹¿å‡ºæ¥æ‰§è¡Œ final List\u003cFrameCallback\u003e _persistentCallbacks = \u003cFrameCallback\u003e[]; /// å°†å›è°ƒæ·»åŠ åˆ° _persistentCallbacks ä¸­ void addPersistentFrameCallback(FrameCallback callback) { _persistentCallbacks.add(callback); } handleDrawFrame() è¢«æ‰§è¡Œæ—¶ï¼Œä¼šä»å›è°ƒåˆ—è¡¨é‡Œé¢å–å‡ºè¿™ä¸ªå›è°ƒï¼Œä»è€Œå±å¹•åˆ·æ–°çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨ drawFrame() å°† Render Tree ç»˜åˆ¶åˆ°ç•Œé¢ä¸Šã€‚\n/// Engine è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥æä¾›æ–°çš„ä¸€å¸§å›¾åƒ void handleDrawFrame() { // PERSISTENT FRAME CALLBACKS _schedulerPhase = SchedulerPhase.persistentCallbacks; for (final FrameCallback callback in _persistentCallbacks) _invokeFrameCallback(callback, _currentFrameTimeStamp!); // ... åªä¿ç•™å…³é”®ä»£ç  } ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç•Œé¢åˆ·æ–°æ—¶ï¼Œç›¸å…³çš„å›è°ƒå·¥ä½œä¼šäº¤ç»™ handleDrawFrame() å»æ‰§è¡Œï¼Œè€Œè¿™ä¸ªæ–¹æ³•é™¤äº†åœ¨ APP å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå…ˆåœ¨ scheduleWarmUpFrame() çš„å®šæ—¶å™¨ä¸­æ‰§è¡Œä¸€æ¬¡è¿›è¡Œé¦–æ¬¡å±•ç¤ºå¤–ï¼Œåœ¨ scheduleAttachRootWidget() æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±ä¼šè¢«æ³¨å†Œåˆ° window.onDrawFrameäº†ä½œä¸ºç•Œé¢åˆ·æ–°çš„å›è°ƒäº†ã€‚ æˆ‘ä»¬é‡‡ç”¨æ–­ç‚¹è°ƒè¯•çš„æ–¹å¼ï¼Œå¯ä»¥çœ‹åˆ° APP å¯åŠ¨çš„æ—¶å€™è¿™ä¸ªæ–¹æ³•çš„æ³¨å†Œè°ƒç”¨é“¾å¦‚ä¸‹ï¼š\nvoid runApp(Widget app) { WidgetsFlutterBinding.ensureInitialized() ..scheduleAttachRootWidget(app) // æå‰æ³¨å†Œå›è°ƒ ..scheduleWarmUpFrame(); } void attachRootWidget(Widget rootWidget) { // å¦‚æœæ˜¯å¼•å¯¼å¸§ï¼Œåˆ™è¿›è¡Œè§†è§‰æ›´æ–° if (isBootstrapFrame) { SchedulerBinding.instance!.ensureVisualUpdate(); } } void ensureVisualUpdate() { switch (schedulerPhase) { case SchedulerPhase.idle: case SchedulerPhase.postFrameCallbacks: scheduleFrame(); // \u003c- å¸§ä»»åŠ¡ return; case SchedulerPhase.transientCallbacks: case SchedulerPhase.midFrameMicrotasks: case SchedulerPhase.persistentCallbacks: return; } } /// ä»¥ä¸‹éƒ½æ˜¯ SchedulerBinding ä¸­çš„æ–¹æ³• void scheduleFrame() { ensureFrameCallbacksRegistered(); // \u003c- ç¡®å®šå›è°ƒçš„æ³¨å†Œ window.scheduleFrame(); // è¯·æ±‚å›è°ƒçš„æ‰§è¡Œï¼Œè¿›è¡Œç•Œé¢æ›´æ–° _hasScheduledFrame = true; } @protected void ensureFrameCallbacksRegistered() { window.onBeginFrame ??= _handleBeginFrame; window.onDrawFrame ??= _handleDrawFrame; // \u003c- æ³¨å†Œå›è°ƒ } æ³¨å†Œçš„è¿™ä¸ªå›è°ƒå…¶å®å°±æ˜¯å¯¹ handleDrawFrame åŒ…äº†ä¸€å±‚å£³ã€‚\nvoid _handleDrawFrame() { if (_rescheduleAfterWarmUpFrame) { _rescheduleAfterWarmUpFrame = false; addPostFrameCallback((Duration timeStamp) { _hasScheduledFrame = false; scheduleFrame(); }); return; } handleDrawFrame(); } window.scheduleFrame() ä¼šå‘ Engine å±‚å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨ä¸‹ä¸€æ¬¡åˆé€‚çš„æ—¶æœºè°ƒç”¨window.onDrawFrameå’Œ window.onBeginFrameæ³¨å†Œçš„å›è°ƒï¼Œä»è€Œåˆ·æ–°ç•Œé¢ã€‚\næœ€åæˆ‘ä»¬é‡‡ç”¨æ–­ç‚¹è°ƒè¯•çš„æ–¹å¼ï¼Œçœ‹ç•Œé¢åˆ·æ–°æ—¶ drawFrame çš„å®Œæ•´è°ƒç”¨é“¾æ˜¯ä»€ä¹ˆæ ·ï¼Œç»¿æ¡†ä¸­çš„å°±æ˜¯æˆ‘ä»¬åˆšåˆšæ‰€è®²åˆ°çš„é‚£äº›æ–¹æ³•äº†ã€‚\nåˆ°è¿™é‡Œï¼ŒçŸ¥è¯†å°±ä¸²èµ·æ¥äº†ï½\næ•´ç†å›¾ æˆ‘ä»¬ç”»å¼ å›¾æ•´ç†ä¸€ä¸‹ï¼Œä¸ºäº†è®©å›¾æ›´åŠ ç®€å•æ˜“çœ‹ï¼Œæˆ‘ä»¬çœç•¥æ‰äº¿ç‚¹ç‚¹ç»†èŠ‚ğŸ¤ã€‚\nFramework é¡¹ç›®ä»£ç å®éªŒ å½“ç„¶äº†è§£å®Œç›¸å…³æµç¨‹ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ Flutter Framework çš„é¡¹ç›®ä¸­è¿›è¡Œå®éªŒï¼ŒæŒ‰ç…§æµç¨‹è‡ªå·±å†™ä¸€éä» Render Tree åˆ°ç•Œé¢åˆ·æ–°çš„ä»£ç ï¼Œè¯æ˜ã€ä¹Ÿæ˜¯ç†Ÿæ‚‰è¿™ä¸ªæµç¨‹ã€‚\né¦–å…ˆæ ¹æ®å®˜æ–¹è¯´æ˜é…ç½®ä¸€ä¸ª Framework å¼€å‘ç¯å¢ƒï¼Œç„¶åè¿›å…¥åˆ° hello_world é¡¹ç›®ä¸­ï¼š https://github.com/flutter/flutter/wiki/Setting-up-the-Framework-development-environment\nå®éªŒé¡¹ç›®å’Œå¹³æ—¶å¼€å‘ä¸€æ ·ä¾æ—§é‡‡ç”¨ Flutter APP çš„æ–¹å¼å¯åŠ¨ï¼Œä½†ä¸åŒçš„æ˜¯æˆ‘ä»¬ä¸è°ƒç”¨ runApp() æ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥åˆ›å»ºä¸€é¢— Render Tree å’Œä½¿ç”¨ Canvasï¼Œé‡‡ç”¨ä¸Šé¢è®²çš„æµç¨‹æ¥æ‰§è¡Œæˆ‘ä»¬çš„ APPã€‚\næˆ‘ä»¬å…ˆå°è¯•ä½¿ç”¨ Canvas ç»˜åˆ¶ä¸€æ¡ç›´çº¿ï¼Œç„¶åç”Ÿæˆ Picture æ·»åŠ åˆ° Sence ä¸­ï¼Œç„¶åå‘é€ç»™ GPU è¿›è¡Œæ¸²æŸ“ã€‚\nimport 'dart:ui'; import 'package:flutter/material.dart'; void main() { final PictureRecorder pictureRecorder = PictureRecorder(); drawLine(pictureRecorder); final Picture picture = pictureRecorder.endRecording(); final SceneBuilder sceneBuilder = SceneBuilder(); sceneBuilder.addPicture(Offset.zero, picture); final Scene scene = sceneBuilder.build(); window.render(scene); } void drawLine(PictureRecorder recorder) { final Canvas canvas = Canvas(recorder); final Paint paint = Paint() ..color = Colors.white ..strokeWidth = 10; canvas.drawLine(Offset(300, 300), Offset(800, 300), paint); } ä¸Šé¢çš„ä»£ç ä¼šåœ¨ç•Œé¢ç»˜åˆ¶ä¸€æ¡ç™½çº¿ï¼Œç”±äºè¿™é‡Œåª render äº†ä¸€æ¬¡ï¼Œå› æ­¤åœ¨ç»˜åˆ¶å®Œè¿™æ¡ç™½çº¿åï¼Œç•Œé¢å°±ä¸ä¼šæœ‰ä»»ä½•å˜åŒ–äº†ã€‚ ç°åœ¨æˆ‘ä»¬å°è¯•è®©çº¿æ¡åŠ¨èµ·æ¥ï¼Œé€šè¿‡ä¸Šé¢çš„è®²è§£ï¼Œæˆ‘ä»¬çŸ¥é“ Flutter æ˜¯ä½¿ç”¨ window.scheduleFrame()æ¥è¯·æ±‚å±å¹•çš„åˆ·æ–°ï¼Œå› æ­¤æˆ‘ä»¬å°†æ¸²æŸ“æ”¾åˆ° window.onDrawFrameä¸­ï¼Œå¹¶ä¸æ–­æ”¹å˜çº¿æ¡ä½ç½®ã€‚\nimport 'dart:ui'; import 'package:flutter/material.dart'; void main() { double dy = 300.0; window.onDrawFrame = () { final PictureRecorder pictureRecorder = PictureRecorder(); drawLine(pictureRecorder, dy); if (dy \u003c 800) dy++; final Picture picture = pictureRecorder.endRecording(); final SceneBuilder sceneBuilder = SceneBuilder(); sceneBuilder.addPicture(Offset.zero, picture); final Scene scene = sceneBuilder.build(); // ä¸æ–­åˆ·æ–°ç•Œé¢ window.render(scene); window.scheduleFrame(); }; window.scheduleFrame(); } void drawLine(PictureRecorder recorder, double dy) { final Canvas canvas = Canvas(recorder); final Paint paint = Paint() ..color = Colors.white ..strokeWidth = 10; canvas.drawLine(Offset(300, dy), Offset(800, dy), paint); } è¿™æ ·å°±å¾—åˆ°äº†ä¸€æ¡ä¼šç§»åŠ¨çš„ç›´çº¿ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸Šé¢çš„ç›´çº¿å°è£…ä¸ºä¸€ä¸ªè‡ªå®šä¹‰çš„ RenderObjectï¼Œç„¶åè‡ªå·±åˆ›å»ºä¸€é¢— Render Treeï¼Œå¹¶ä½¿ç”¨ drawFrame() æ–¹æ³•ä¸­çš„æµç¨‹ï¼šä½¿ç”¨ PipelineOwner æ¥é‡æ–°ç»˜åˆ¶è¢«æ±¡æŸ“çš„èŠ‚ç‚¹ã€‚\nvoid main() { // æ„å»ºæ ¹èŠ‚ç‚¹ final PipelineOwner pipelineOwner = PipelineOwner(); final RenderView renderView = RenderView(configuration: const ViewConfiguration(), window: window); pipelineOwner.rootNode = renderView; // åˆå§‹åŒ– renderView.prepareInitialFrame(); renderView.child = MyRenderNode(); window.onDrawFrame = () { callFlush(pipelineOwner); renderView.compositeFrame(); window.scheduleFrame(); }; window.scheduleFrame(); } void callFlush(PipelineOwner pipelineOwner) { pipelineOwner.flushLayout(); pipelineOwner.flushCompositingBits(); pipelineOwner.flushPaint(); } class MyRenderNode extends RenderBox { double _dy = 300; final Paint _paint = Paint() ..color = Colors.white ..strokeWidth = 10; void _drawLines(Canvas canvas, double dy) { canvas.drawLine(Offset(300, dy), Offset(800, dy), _paint); } @override void paint(PaintingContext context, Offset offset) { _drawLines(context.canvas, _dy); _dy++; markNeedsLayout(); } } è¿™ä»½ä»£ç è¿è¡Œçš„æ•ˆæœå’Œä¸Šé¢çš„æ˜¯ä¸€æ ·çš„ï¼Œä½†åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¹¶ä¸èƒ½çœ‹å‡ºè½¬åŒ–ä¸º Layer Tree çš„ä¼˜åŠ¿ï¼Œæˆ‘ä»¬æ¥æ„å»ºä¸€é¢—å¤šä¸ªèŠ‚ç‚¹çš„ Render Treeã€‚æˆ‘ä»¬é‡‡ç”¨ RenderFlex æ¥å­˜å‚¨å¤šä¸ªèŠ‚ç‚¹ï¼Œå¹¶å’Œä¸Šé¢è®²è§£ flushLayout()æ—¶æ‰€è¯´çš„ä¸€æ ·äº¤ç”±çˆ¶èŠ‚ç‚¹æ¥å†³å®šå¸ƒå±€å¤§å°ã€‚\nvoid main() { // æ„å»ºæ ¹èŠ‚ç‚¹ final PipelineOwner pipelineOwner = PipelineOwner(); final RenderView renderView = RenderView(configuration: const ViewConfiguration(), window: window); pipelineOwner.rootNode = renderView; // åˆå§‹åŒ– renderView.prepareInitialFrame(); final RenderFlex flex = RenderFlex(textDirection: TextDirection.ltr); // ä» 301 å¼€å§‹ç§»åŠ¨åˆ° 500 ä¸€å…±ç»˜åˆ¶äº† 200 æ¬¡ double dy = 301; // åˆ›å»ºä¸¤ä¸ªå¶å­èŠ‚ç‚¹ final MyRenderNode node1 = MyRenderNode(dy, Colors.white); final MyRenderNode node2 = MyRenderNode(dy, Colors.blue); renderView.child = flex; // æ³¨æ„è¿™é‡Œæ˜¯å¾€å‰æ’å…¥ flex.insert(node1); flex.insert(node2); window.onDrawFrame = () { callFlush(pipelineOwner); renderView.compositeFrame(); if (dy \u003c 500) { node1.dy = ++dy; window.scheduleFrame(); } else { print('node1 paint count: ${node1.paintCount}'); print('node2 paint count: ${node2.paintCount}'); } }; window.scheduleFrame(); } void callFlush(PipelineOwner pipelineOwner) { pipelineOwner.flushLayout(); pipelineOwner.flushCompositingBits(); pipelineOwner.flushPaint(); } class MyRenderNode extends RenderBox { MyRenderNode(this._dy, Color color) { _paint = Paint() ..color = color ..strokeWidth = 10; } double _dy; int paintCount = 0; set dy(double dy) { _dy = dy; markNeedsLayout(); } double get dy =\u003e _dy; late Paint _paint; void _drawLines(Canvas canvas, double dy) { canvas.drawLine(Offset(300, dy), Offset(800, dy), _paint); } @override void paint(PaintingContext context, Offset offset) { _drawLines(context.canvas, dy); paintCount++; } @override bool get sizedByParent =\u003e true; @override Size computeDryLayout(BoxConstraints constraints) { return constraints.smallest; } } è¿™ä»½ä»£ç æ¯”è¾ƒé•¿ï¼Œå¯¹äº MyRenderNodeçš„ä¿®æ”¹ï¼š\né¦–å…ˆæˆ‘ä»¬é‡å†™äº† sizedByParentå’Œ computeDryLayout()ï¼Œç”¨äºåœ¨å¸ƒå±€æµ‹é‡æ—¶å†³å®šå¤§å° _dy å±æ€§æ·»åŠ äº† setter æ–¹æ³•ï¼Œåœ¨æ¯æ¬¡ä¿®æ”¹ _dy çš„å€¼æ—¶è°ƒç”¨ markNeedsLayout() æ¥è®©ä¸‹ä¸€æ¬¡ç•Œé¢åˆ·æ–°æ—¶é‡æ–°ç»˜åˆ¶èŠ‚ç‚¹ å¦å¤–æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ª piantCount å±æ€§æ¥è®°å½•èŠ‚ç‚¹ç»˜åˆ¶äº†å‡ æ¬¡ æ¥ç€æ˜¯ main æ–¹æ³•ä¸­ï¼š\nä½¿ç”¨ RenderFlex ä½œä¸º RenderView çš„å­èŠ‚ç‚¹ åˆ›å»ºäº†ä¸¤ä¸ªå­èŠ‚ç‚¹æ’å…¥åˆ° RenderFlex ä¸­ æ¯æ¬¡æ¸²æŸ“æ—¶ï¼Œéƒ½ä¼šä¿®æ”¹ node1 çš„ dyï¼Œè®©ä»–è¿›è¡Œé‡ç»˜ï¼Œnode2 åˆ™ä¸åšä¿®æ”¹ å½“ dy çš„å€¼è¾¾åˆ°äº† 500 çš„æ—¶å€™åœæ­¢ç•Œé¢åˆ·æ–°å¹¶æ‰“å°ä¸¤ä¸ªèŠ‚ç‚¹çš„ç»˜åˆ¶æ¬¡æ•° æ•ˆæœå¦‚ä¸Šï¼Œä¼šæœ‰ä¸€æ ¹ä¸åŠ¨çš„è“çº¿ï¼Œå’Œä¸€æ ¹ç§»åŠ¨çš„ç™½çº¿ã€‚ æˆ‘ä»¬å†çœ‹çœ‹æ§åˆ¶å°æ‰“å°çš„ä¿¡æ¯ã€‚\næˆ‘ä»¬å‘ç°ä¸¤ä¸ªèŠ‚ç‚¹çš„ç»˜åˆ¶æ¬¡æ•°éƒ½æ˜¯ 200ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡æ¸²æŸ“ä¸¤ä¸ªèŠ‚ç‚¹éƒ½è¿›è¡Œäº†é‡æ–°ç»˜åˆ¶ï¼Œæ ¹æ®ä¸Šé¢æˆ‘ä»¬è®²åˆ°çš„ PaintingContext å’Œ Layer çš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«åˆ¤æ–­å‡ºï¼Œè¿™æ˜¯ç”±äº node1 å’Œ node2 æ²¡æœ‰åˆ†å¼€ç»˜åˆ¶ï¼Œä½¿ç”¨åŒä¸€ä¸ª Layer èŠ‚ç‚¹æ‰€é€ æˆçš„ã€‚\nç”±äº node1 è¢«æ±¡æŸ“åä¹Ÿä¼šè°ƒç”¨çˆ¶èŠ‚ç‚¹ flex çš„ markNeedsPaint()ï¼Œå› æ­¤ç»˜åˆ¶æ“ä½œæ—¶ç”±çˆ¶èŠ‚ç‚¹å‘ä¸‹ç»˜åˆ¶çš„ï¼Œè€Œ node2 ä¹Ÿæ˜¯ flex çš„å­èŠ‚ç‚¹ï¼Œæ•´æ£µå­æ ‘éƒ½ä¼šé‡æ–°ç»˜åˆ¶ï¼Œè¿™å°±æ˜¯ node2 æ±¡æŸ“æ—¶ node1 ä¹Ÿè·Ÿç€é‡ç»˜çš„åŸå› ã€‚ â€‹\næˆ‘ä»¬åœ¨è‡ªå®šä¹‰çš„ RenderBox é‡Œé‡å†™ isRepaintBoundary å±æ€§ï¼Œå¹¶åœ¨ framework å±‚ä¸º ContainerLayer æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹è®¡æ•°æ–¹æ³•ã€‚\n/// ContainerLayer int layerCount() { int count = 1; // ç®—ä¸Šå½“å‰èŠ‚ç‚¹ Layer? child = firstChild; while (child != null) { if(child is OffsetLayer) count += child.layerCount(); else count += 1; child = child.nextSibling; } return count; } void main() { window.onDrawFrame = () { if (dy \u003c 500) { node1.dy = ++dy; window.scheduleFrame(); } else { print('node1 paint count: ${node1.paintCount}'); print('node2 paint count: ${node2.paintCount}'); // åœ¨ç»“æŸæ—¶æ‰“å° Layer çš„æ•°é‡ print('layer count: ${renderView.layer?.layerCount()}'); } }; } class MyRenderNode extends RenderBox { bool _isRepaintBoundary = false; @override bool get isRepaintBoundary =\u003e _isRepaintBoundary; /// æ·»åŠ è®¾ç½®æ–¹æ³• set isRepaintBoundary(bool v) { _isRepaintBoundary = v; } } æˆ‘ä»¬å…ˆæ¥æ¼”ç¤ºä¸¤ç§æƒ…å†µï¼š\nä¸å¯¹ä¸¤ä¸ªå¶å­èŠ‚ç‚¹çš„ isRepaintBoundary è¿›è¡Œä¿®æ”¹ å°† node1 å•ç‹¬ç»˜åˆ¶ï¼šnode1.isRepaintBoundary = false; å¯ä»¥çœ‹åˆ° node1 çš„ isRepaintBoundary è®¾ç½®ä¸º true æ—¶ï¼Œ node2 åªç»˜åˆ¶äº† 1 æ¬¡ï¼Œç°åœ¨ node2 çš„æ±¡æŸ“å°±ä¸ä¼šå¯¼è‡´ node1 é‡ç»˜åˆ¶äº†ã€‚\nå¦å¤–æˆ‘ä»¬çœ‹åˆ°ç¬¬äºŒç§æƒ…å†µçš„ Layer èŠ‚ç‚¹æ•°é‡åˆ†æ˜¯ 4ï¼Œä¸ºä»€ä¹ˆä¼šæ˜¯ 4 å‘¢ï¼Ÿ\nå›æƒ³ä¸€ä¸‹ä»‹ç» PaintingContext åˆ›å»ºæ—¶æä¾› Layout çš„è¦æ±‚ï¼š\nå½“æä¾›ç»™ PaintingContext çš„ Layer èŠ‚ç‚¹ä¸å±äº OffsetLayer æ—¶ ï¼Œä¼šåˆ›å»ºä¸€ä¸ª OffsetLayer æ¥ä»£æ›¿åŸæœ¬çš„ Layerï¼Œä½œä¸ºå½“å‰å­æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚\nå¦‚æœæˆ‘ä»¬å¯¹ç¨‹åºè¿›è¡Œè°ƒè¯•ï¼Œå°±å¯ä»¥å‘ç°ï¼Œè™½ç„¶æ˜¯ä»¥ node1ã€node2 çš„é¡ºåºæ’å…¥ï¼Œä½†å®é™… insert() æ–¹æ³•æ˜¯å¾€å‰æ’å…¥ï¼Œåœ¨ flex ä¸­ node2 æ˜¯å¤„äº node1 çš„å‰é¢ï¼Œå› æ­¤ node2 ä¼šå…ˆè¿›è¡Œç»˜åˆ¶ã€‚\nç”±äº node2 å¹¶æ²¡æœ‰è®¾ç½®å•ç‹¬ç»˜åˆ¶ï¼Œå› æ­¤ä¼šæŒ‰ç…§æ­£å¸¸æµç¨‹å’Œ flex ç»˜åˆ¶åœ¨åŒä¸€ä¸ª PictureRecorder ä¸­ç”Ÿæˆä¸€ä¸ª PictureLayer å¹¶æ·»åŠ åˆ° TransformLayer ä¸­ã€‚\nnode2 ç»˜åˆ¶å®Œæˆä¹‹åå¼€å§‹ç»˜åˆ¶ node1ã€‚ç”±äºæˆ‘ä»¬å°† node1 è®¾ç½®ä¸ºå•ç‹¬ç»˜åˆ¶ï¼Œé‚£ä¹ˆç»˜åˆ¶ node1 çš„æ—¶å€™å°†ä¼šä½œä¸ºä¸€ä¸ªå­æ ‘é‡æ–°å¼€å§‹ç»˜åˆ¶ï¼Œè¿™æ—¶ä¼šé‡æ–°è°ƒç”¨ _repaintCompositedChild()æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ PaintingContext æ¥ä¼ é€’ï¼Œæ­¤æ—¶ç”±äº node1 æ˜¯ä¸€ä¸ªå¶å­ç»“ç‚¹ï¼Œæœ¬èº«å¹¶ä¸é™„å¸¦ OffsetLayer èŠ‚ç‚¹ï¼Œå› æ­¤ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ OffsetLayer ç»™ PaintingConextï¼Œå†è¿›è¡Œç»˜åˆ¶ã€‚\nç»˜åˆ¶ node 1 æ—¶ç”Ÿæˆçš„ PictureLayer æ·»åŠ åˆ°è¿™ä¸ª OffsetLayout ä¸­ï¼Œå®Œæˆç»˜åˆ¶ä¹‹åå†å°† OffsetLayout æ·»åŠ åˆ° RenderView çš„ TransformLayer ä¸­ã€‚\nå› æ­¤ç¬¬ 2 ç§æƒ…å†µä¼šå¾—åˆ° 4 ä¸ª Layer èŠ‚ç‚¹ï¼Œå¯¹åº”çš„ Layer å›¾ç¤ºå¦‚ä¸‹ï¼š\næˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹è®¡æ•°æ–¹æ³•ï¼Œè®©å®ƒæ‰“å°å½“å‰éå†çš„å±‚æ¬¡å’ŒèŠ‚ç‚¹ç±»å‹ã€‚\nint layerCount() { int deep = 0; print('$deep ==\u003e root is [${this.runtimeType}]'); return _layerCount(deep + 1); } int _layerCount(int deep) { int count = 1; // ç®—ä¸Šå½“å‰èŠ‚ç‚¹ Layer? child = firstChild; while (child != null) { print('$deep ==\u003e child is [${child.runtimeType}]'); if(child is OffsetLayer) count += child._layerCount(deep + 1); else count += 1; child = child.nextSibling; } return count; } å¯ä»¥çœ‹åˆ°å’Œæˆ‘ä»¬ç”»çš„è½¬åŒ–å›¾æ˜¯ä¸€æ ·çš„ã€‚å¦‚æœæˆ‘ä»¬å°† node1 å’Œ node2 äº¤æ¢ä¸€ä¸‹ï¼Œå…ˆæ·»åŠ  node2 å†æ·»åŠ  node1ï¼Œä½¿ node1 å…ˆè¿›è¡Œç»˜åˆ¶ï¼Œé‚£ä¹ˆç»“æœä¼šæ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿ\nflex.insert(node2); flex.insert(node1); å¯ä»¥çœ‹åˆ°ä¾æ—§æ˜¯ 4 ä¸ª Layer èŠ‚ç‚¹ï¼Œnode2 ç”Ÿæˆçš„ PictureLayer ä¾æ—§æ˜¯ TransformLayer çš„å­èŠ‚ç‚¹ã€‚\næˆ‘ä»¬çœ‹ä¸€ä¸‹ RenderFlex æ˜¯å¦‚ä½•ç»˜åˆ¶å­èŠ‚ç‚¹çš„ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒè¯•è¿›å…¥ RenderFlex çš„ paint() æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨çš„æ˜¯ paintDefault()ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œéå†ä¾æ¬¡è°ƒç”¨å½“å‰ PaintingContext çš„ paintChild() ç»˜åˆ¶å­èŠ‚ç‚¹ã€‚\nvoid defaultPaint(PaintingContext context, Offset offset) { ChildType? child = firstChild; // éå†å­èŠ‚ç‚¹è¿›è¡Œç»˜åˆ¶ while (child != null) { final ParentDataType childParentData = child.parentData! as ParentDataType; context.paintChild(child, childParentData.offset + offset); child = childParentData.nextSibling; } } RenderFlex å¾ªç¯ç»˜åˆ¶æ—¶ï¼Œçˆ¶èŠ‚ç‚¹å’Œä¸‹é¢çš„å­èŠ‚ç‚¹ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ª PaintingContexã€‚ç”±äº node1 æ˜¯å•ç‹¬ç»˜åˆ¶ï¼Œå› æ­¤ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ PaintingContext å’Œ OffsetLayerï¼Œä½†ç»˜åˆ¶ node2 æ—¶è¿˜æ˜¯ä½¿ç”¨çˆ¶èŠ‚ç‚¹çš„ PaintingContextï¼Œæ‰€ä»¥ flex å’Œ node2 ä¼šä¸€èµ·ç”Ÿæˆä¸€ä¸ª PictureLayer æ·»åŠ åˆ°æ ¹èŠ‚ç‚¹ä¸­ã€‚\nç»“è¯­ æœ¬æ–‡åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥çœ‹åˆ°ï¼ŒFlutter æ€§èƒ½é«˜çš„ä¸€ä¸ªå¾ˆé‡è¦çš„åŸå› ï¼Œå°±æ˜¯å®ƒåœ¨èµ„æºå¤ç”¨å’Œé¿å…ä¸å¿…è¦è®¡ç®—ç­‰æ–¹é¢ï¼Œåšäº†å¾ˆå¤šæ€è€ƒã€‚\nä¹‹æ‰€ä»¥ç ”ç©¶è¿™éƒ¨åˆ†ï¼Œæ˜¯å› ä¸ºè¿™éƒ¨åˆ†æ˜¯ Flutter Framework å±‚æœ€è´´è¿‘ Engine å±‚çš„å†…å®¹ï¼Œå¯¹ä»¥åç ”ç©¶ Flutter å’Œ Android ä¸¤è€…åœ¨ Engine å±‚çš„å¼‚åŒç‚¹ä¼šæœ‰å¾ˆå¤§å¸®åŠ©ã€‚\nç”±äºæ¶‰åŠåˆ°çš„ä¸œè¥¿ç‰¹åˆ«å¤šï¼Œå› æ­¤å¹¶æ²¡åŠæ³•è®²çš„å¾ˆå…¨é¢ï¼Œæœ¬æ–‡æ‰€è¦ä»‹ç»çš„å†…å®¹ä¹Ÿå¯èƒ½å­˜åœ¨é—æ¼ï¼Œä½†æŒ‰ç…§æœ¬æ–‡è®²è§£çš„æµç¨‹å»é˜…è¯»æºç è¿›è¡Œæ‰©å±•ï¼Œå¹¶ä¸éš¾å¼„æ‡‚ï¼Œæœ‰é—®é¢˜å¯åœ¨è¯„è®ºåŒºç•™è¨€ã€‚\n","wordCount":"2875","inLanguage":"en","datePublished":"2022-01-11T00:00:00Z","dateModified":"2022-01-11T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"http://answerkobe.github.io/posts/analysis-flutter-paint-process/"},"publisher":{"@type":"Organization","name":"Iverson's blog","logo":{"@type":"ImageObject","url":"http://answerkobe.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://answerkobe.github.io/ accesskey=h title="Iverson's blog (Alt + H)">Iverson's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://answerkobe.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=http://answerkobe.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=http://answerkobe.github.io/profile title=Profile-X><span>Profile-X</span></a></li><li><a href=http://answerkobe.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://answerkobe.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=http://answerkobe.github.io/posts/>Posts</a></div><h1 class=post-title>Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ</h1><div class=post-meta><span title='2022-01-11 00:00:00 +0000 UTC'>January 11, 2022</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#render-tree-%e7%9a%84%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b aria-label="Render Tree çš„åˆ›å»ºè¿‡ç¨‹">Render Tree çš„åˆ›å»ºè¿‡ç¨‹</a><ul><li><a href=#renderobject-%e7%9a%84%e7%b1%bb%e5%9e%8b aria-label="RenderObject çš„ç±»å‹">RenderObject çš„ç±»å‹</a></li><li><a href=#renderview-%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba aria-label="RenderView å¦‚ä½•åˆ›å»º">RenderView å¦‚ä½•åˆ›å»º</a></li><li><a href=#%e4%b8%89%e6%a3%b5%e6%a0%91%e7%9a%84%e5%88%9d%e5%a7%8b%e5%8c%96%e5%85%b3%e8%81%94 aria-label=ä¸‰æ£µæ ‘çš„åˆå§‹åŒ–å…³è”>ä¸‰æ£µæ ‘çš„åˆå§‹åŒ–å…³è”</a></li></ul></li><li><a href=#pipelineowner-%e6%b8%b2%e6%9f%93%e7%ae%a1%e9%81%93%e7%ae%a1%e7%90%86 aria-label="PipelineOwner æ¸²æŸ“ç®¡é“ç®¡ç†">PipelineOwner æ¸²æŸ“ç®¡é“ç®¡ç†</a><ul><li><a href=#flushlayout aria-label=flushLayout>flushLayout</a></li><li><a href=#flushcompositingbits aria-label=flushCompositingBits>flushCompositingBits</a></li><li><a href=#flushpaint aria-label=flushPaint>flushPaint</a></li></ul></li><li><a href=#%e5%9c%ba%e6%99%af%e5%90%88%e6%88%90%e4%b8%8e%e7%95%8c%e9%9d%a2%e5%88%b7%e6%96%b0%e6%b8%b2%e6%9f%93 aria-label=åœºæ™¯åˆæˆä¸ç•Œé¢åˆ·æ–°æ¸²æŸ“>åœºæ™¯åˆæˆä¸ç•Œé¢åˆ·æ–°æ¸²æŸ“</a><ul><li><a href=#canvas-%e4%b8%8e%e7%bb%98%e5%88%b6%e5%ad%98%e5%82%a8 aria-label="Canvas ä¸ç»˜åˆ¶å­˜å‚¨">Canvas ä¸ç»˜åˆ¶å­˜å‚¨</a></li><li><a href=#layer-tree aria-label="Layer Tree">Layer Tree</a></li><li><a href=#%e8%8a%82%e7%82%b9%e7%9a%84%e7%bb%98%e5%88%b6%e5%88%86%e7%a6%bb aria-label=èŠ‚ç‚¹çš„ç»˜åˆ¶åˆ†ç¦»>èŠ‚ç‚¹çš„ç»˜åˆ¶åˆ†ç¦»</a></li><li><a href=#%e5%9c%ba%e6%99%af%e6%b8%b2%e6%9f%93 aria-label=åœºæ™¯æ¸²æŸ“>åœºæ™¯æ¸²æŸ“</a></li><li><a href=#%e7%95%8c%e9%9d%a2%e5%88%b7%e6%96%b0 aria-label=ç•Œé¢åˆ·æ–°>ç•Œé¢åˆ·æ–°</a></li></ul></li><li><a href=#%e6%95%b4%e7%90%86%e5%9b%be aria-label=æ•´ç†å›¾>æ•´ç†å›¾</a></li><li><a href=#framework-%e9%a1%b9%e7%9b%ae%e4%bb%a3%e7%a0%81%e5%ae%9e%e9%aa%8c aria-label="Framework é¡¹ç›®ä»£ç å®éªŒ">Framework é¡¹ç›®ä»£ç å®éªŒ</a></li><li><a href=#%e7%bb%93%e8%af%ad aria-label=ç»“è¯­>ç»“è¯­</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=render-tree-çš„åˆ›å»ºè¿‡ç¨‹>Render Tree çš„åˆ›å»ºè¿‡ç¨‹<a hidden class=anchor aria-hidden=true href=#render-tree-çš„åˆ›å»ºè¿‡ç¨‹>#</a></h2><h3 id=renderobject-çš„ç±»å‹>RenderObject çš„ç±»å‹<a hidden class=anchor aria-hidden=true href=#renderobject-çš„ç±»å‹>#</a></h3><p>æˆ‘ä»¬çŸ¥é“ Element ä¸»è¦åˆ†ä¸ºè´Ÿè´£æ¸²æŸ“çš„ <strong>RenderObjectElement</strong> å’Œè´Ÿè´£ç»„åˆçš„ <strong>ComponentElement</strong> ä¸¤å¤§ç±»ï¼Œè€Œåˆ›å»º RenderObject èŠ‚ç‚¹çš„æ˜¯å‰è€… <code>mount()</code> æ–¹æ³•ä¸­è°ƒç”¨çš„ <code>RenderObjectWidget.createRenderObject()</code> æ–¹æ³•ã€‚</p><p>è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å­ç±»å®ç°ï¼Œå¯¹äºä¸åŒçš„å¸ƒå±€çš„ Widget åˆ›å»ºçš„ RenderObject ç±»å‹ä¹Ÿä¸ä¸€æ ·ï¼Œåœ¨ Render Tree ä¸­æœ€ä¸»è¦çš„æœ‰ä¸¤ç§ RenderObjectï¼š</p><ul><li>é¦–å…ˆæ˜¯åœ¨ RenderObject æ³¨é‡Šè¯´æ˜ä¸­å¤§é‡æåˆ°äº†ä¸€ä¸ªç±» <strong>RenderBox</strong>ï¼Œå®ƒæ˜¯å¤§éƒ¨åˆ†çš„ RenderObjectWidget æ‰€å¯¹åº”çš„ RenderObject çš„æŠ½è±¡ç±»</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// A render object in a 2D Cartesian coordinate system.
</span></span></span><span style=display:flex><span><span style=color:#75715e>/// ä¸€ä¸ªåœ¨ 2D åæ ‡ç³»ä¸­çš„æ¸²æŸ“å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RenderBox</span> <span style=color:#66d9ef>extends</span> RenderObject
</span></span></code></pre></div><ul><li>ä»¥åŠ Render Tree çš„æ ¹èŠ‚ç‚¹ <strong>RenderView</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// The root of the render tree.
</span></span></span><span style=display:flex><span><span style=color:#75715e>/// Render Tree çš„æ ¹èŠ‚ç‚¹ï¼Œå¤„ç†æ¸²æŸ“ç®¡é“çš„å¼•å¯¼å’Œæ¸²æŸ“æ ‘çš„è¾“å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e>/// å®ƒæœ‰ä¸€ä¸ªå¡«å……æ•´ä¸ªè¾“å‡ºè¡¨é¢çš„ RenderBox ç±»å‹çš„å”¯ä¸€å­èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RenderView</span> <span style=color:#66d9ef>extends</span> RenderObject <span style=color:#66d9ef>with</span> RenderObjectWithChildMixin<span style=color:#f92672>&lt;</span>RenderBox<span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><p>å…¶ä»–çš„ç±»å‹çš„ RenderObject åŸºæœ¬æ˜¯ä¸ºäº†ç‰¹å®šå¸ƒå±€ï¼ˆå¦‚æ»‘åŠ¨ã€åˆ—è¡¨ï¼‰çš„å®ç°ï¼Œä½†å¤§éƒ¨åˆ†éƒ½ç›´æ¥æˆ–é—´æ¥é›†æˆè‡ª RenderBoxã€‚</p><p>é€šå¸¸ä¸€ä¸ª RenderBox åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼ˆå› ä¸ºå®ƒåªæœ‰ä¸€ä¸ª child å±æ€§ï¼‰ï¼Œè¿™ä½¿å¾—å®ƒæ•´ä½“æ›´åƒæ˜¯é“¾è¡¨ã€‚
Flutter æä¾›äº† <code>ContainerRenderObjectMixin</code> ç”¨æ¥ç»™é‚£äº›éœ€è¦å­˜å‚¨å¤šä¸ªå­èŠ‚ç‚¹çš„ RenderBox è¿›è¡Œæ‰©å±•ï¼Œå¤šä¸ªå­èŠ‚ç‚¹çš„ç»„ç»‡æ–¹å¼ä¹Ÿæ˜¯é‡‡ç”¨é“¾è¡¨æ¥è¿æ¥å­˜å‚¨ï¼Œä¸‹é¢åˆ—å‡ºå¸¸è§çš„ä¸¤ç§ï¼š</p><ul><li><strong>RenderStack</strong> å®ç°äº†å †æ ˆå¸ƒå±€ç®—æ³•</li><li><strong>RenderFlex</strong> å®ç°äº† <strong>Flex</strong> å¸ƒå±€ç®—æ³•ï¼ŒColumn å’Œ Row éƒ½æ˜¯å±äº Flex çš„å˜ä½“</li></ul><h3 id=renderview-å¦‚ä½•åˆ›å»º>RenderView å¦‚ä½•åˆ›å»º<a hidden class=anchor aria-hidden=true href=#renderview-å¦‚ä½•åˆ›å»º>#</a></h3><p>æ—¢ç„¶ Render Tree çš„æ ¹èŠ‚ç‚¹æ˜¯ RenderViewï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ RenderView æ˜¯åœ¨å“ªè¢«åˆ›å»ºçš„ã€‚</p><p>é€šè¿‡ IDE çš„å…¨å±€æœç´¢æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„åˆ›å»ºå¼•ç”¨æ˜¯åœ¨ <code>RendererBinding</code> ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// Flutter å¼•æ“å’Œ Render Tree ä¹‹é—´çš„ä¸€ä¸ªç»‘å®šå™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mixin RendererBinding on BindingBase, ServicesBinding,
</span></span><span style=display:flex><span>SchedulerBinding, GestureBinding, SemanticsBinding, HitTestable
</span></span></code></pre></div><p>è¿™ä¸ªç±»å»ºç«‹äº† Flutter Engine å’Œ Render Tree ä¹‹é—´çš„å…³è”ï¼Œæ³¨é‡Šä¸­ä»‹ç»ï¼Œå½“ Binding è¢«åˆ›å»ºçš„æ—¶å€™å°±ä¼šæ‰§è¡Œ
<code>initInstances()</code> è¿›è¡Œåˆå§‹åŒ–å¹¶åˆ›å»º RenderViewã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// RendererBinding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> initInstances() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ... çœç•¥äº† PipelineOwner åˆ›å»ºå’Œ window åˆå§‹åŒ–ä»£ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// åˆ›å»º RenderView
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  initRenderView();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// Called automatically when the binding is created.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> initRenderView() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  renderView <span style=color:#f92672>=</span> RenderView(
</span></span><span style=display:flex><span>    configuration: createViewConfiguration(),
</span></span><span style=display:flex><span>    window: window);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆå§‹åŒ– RenderView
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  renderView.prepareInitialFrame();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬å›åˆ° Flutter App å¯åŠ¨æ—¶è°ƒç”¨çš„å‡½æ•° runAppã€‚</p><p>runApp ä¼šåˆ›å»º <code>WidgetsFlutterBinding</code>ï¼Œå¹¶æ‰§è¡Œ <code>ensureInitialized()</code> æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>void</span> runApp(Widget app) {
</span></span><span style=display:flex><span>  WidgetsFlutterBinding.ensureInitialized() <span style=color:#75715e>//åˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ..scheduleAttachRootWidget(app) <span style=color:#75715e>// åˆ›å»ºå…¶ä»–ä¸¤æ£µæ ‘çš„æ ¹èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ..scheduleWarmUpFrame();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è€Œè¿™ä¸ª <code>WidgetsFlutterBinding</code> å®é™…ä¸Šç”± 7 ä¸ª mixin Binding ç»„åˆæˆï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº† <code>RendererBinding</code>ï¼Œè€Œè°ƒç”¨è¿™å‡ ä¸ª mixin Binding çš„ <code>initInstances()</code> éƒ½æ˜¯äº¤ç»™çˆ¶ç±» BindingBase åœ¨æ„é€ æ–¹æ³•ä¸­æ‰§è¡Œã€‚</p><p>è¿™ç§é‡‡ç”¨ mixin ç»„åˆ Binding çš„è®¾è®¡å¯ä»¥æ–¹ä¾¿åç»­æ¥å…¥æ–°çš„ Bindingã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WidgetsFlutterBinding</span> <span style=color:#66d9ef>extends</span> BindingBase
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>with</span> GestureBinding, SchedulerBinding, ServicesBinding,
</span></span><span style=display:flex><span>PaintingBinding, SemanticsBinding, RendererBinding, WidgetsBinding {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> WidgetsBinding ensureInitialized() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (WidgetsBinding.instance <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>      WidgetsFlutterBinding();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> WidgetsBinding.instance<span style=color:#f92672>!</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BindingBase</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>/// Default abstract constructor for bindings.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>///
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// First calls [initInstances] to have bindings initialize their
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// instance pointers and other state, then calls
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// [initServiceExtensions] to have bindings initialize their
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// observatory service extensions, if any.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  BindingBase() {
</span></span><span style=display:flex><span>    initInstances();
</span></span><span style=display:flex><span>    initServiceExtensions();
</span></span><span style=display:flex><span>    developer.postEvent(<span style=color:#e6db74>&#39;Flutter.FrameworkInitialization&#39;</span>, <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>String</span><span style=color:#f92672>&gt;</span>{});
</span></span><span style=display:flex><span>    developer.Timeline.finishSync();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ä¸‰æ£µæ ‘çš„åˆå§‹åŒ–å…³è”>ä¸‰æ£µæ ‘çš„åˆå§‹åŒ–å…³è”<a hidden class=anchor aria-hidden=true href=#ä¸‰æ£µæ ‘çš„åˆå§‹åŒ–å…³è”>#</a></h3><p>åœ¨<code>ensureInitialized()</code> æ–¹æ³•æ‰§è¡Œå®Œæˆå¾—åˆ° Render Tree æ ¹èŠ‚ç‚¹ä¹‹åï¼Œå°±æ˜¯è°ƒç”¨ <code>scheduleAttachRootWidget()</code> åˆ›å»ºå…¶ä»–ä¸¤æ£µæ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œç„¶åå’Œ Render Tree è¿›è¡Œå…³è”ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>protected
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> scheduleAttachRootWidget(Widget rootWidget) {
</span></span><span style=display:flex><span>  Timer.run(() {
</span></span><span style=display:flex><span>    attachRootWidget(rootWidget);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> attachRootWidget(Widget rootWidget) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>bool</span> isBootstrapFrame <span style=color:#f92672>=</span> renderViewElement <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  _readyToProduceFrames <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  _renderViewElement <span style=color:#f92672>=</span> RenderObjectToWidgetAdapter<span style=color:#f92672>&lt;</span>RenderBox<span style=color:#f92672>&gt;</span>(
</span></span><span style=display:flex><span>    container: renderView,
</span></span><span style=display:flex><span>    debugShortDescription: <span style=color:#e6db74>&#39;[root]&#39;</span>,
</span></span><span style=display:flex><span>    child: rootWidget,
</span></span><span style=display:flex><span>  ).attachToRenderTree(
</span></span><span style=display:flex><span>    buildOwner<span style=color:#f92672>!</span>,
</span></span><span style=display:flex><span>    renderViewElement <span style=color:#f92672>as</span> RenderObjectToWidgetElement<span style=color:#f92672>&lt;</span>RenderBox<span style=color:#f92672>&gt;?</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (isBootstrapFrame) {
</span></span><span style=display:flex><span>    SchedulerBinding.instance<span style=color:#f92672>!</span>.ensureVisualUpdate();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨è¿™é‡Œ<code>attachRootWidget()</code> åˆ›å»ºäº† RenderObjectToWidgetAdapterï¼Œå®ƒçš„æœ¬è´¨å…¶å®æ˜¯ RenderObjectWidgetï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå£°æ˜äº†å¯¹åº”çš„ Render Tree çš„èŠ‚ç‚¹ç±»å‹ä¸º RenderBoxï¼Œå¹¶ä¸”æŒ‡å®šäº†è¯¥ RenderBox çš„çˆ¶èŠ‚ç‚¹æ˜¯ RenderViewã€‚</p><p>æœ€åè°ƒç”¨ <code>attachToRenderTree()</code> å°† RenderObjectToWidgetAdapter è½¬åŒ–ä¸º RootRenderObjectElement å¹¶å’Œ Render Tree è¿›è¡Œç»‘å®šã€‚</p><hr><h2 id=pipelineowner-æ¸²æŸ“ç®¡é“ç®¡ç†>PipelineOwner æ¸²æŸ“ç®¡é“ç®¡ç†<a hidden class=anchor aria-hidden=true href=#pipelineowner-æ¸²æŸ“ç®¡é“ç®¡ç†>#</a></h2><p>ç›®å‰çš„ Render Tree åªæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå¹¶æ²¡æœ‰æ¸²æŸ“æ“ä½œã€‚å› æ­¤æˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹ä» Render Tree åˆ°ç•Œé¢æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„è¿‡ç¨‹ã€‚</p><p>åˆšåˆšæåˆ°äº† RenderBinding å»ºç«‹äº† Flutter Engine å’Œ Render Tree ä¹‹é—´çš„å…³è”ï¼Œåœ¨åˆ›å»º RenderView çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°å®ƒè¿˜åˆ›å»ºäº†ä¸€ä¸ª <strong>PipelineOwner</strong> çš„å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨è®¾ç½® renderView æ—¶è¿˜å°† RenderView èµ‹å€¼ç»™äº†å®ƒçš„ rootNodeã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// RendererBinding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> initInstances() {
</span></span><span style=display:flex><span>  _pipelineOwner <span style=color:#f92672>=</span> PipelineOwner(
</span></span><span style=display:flex><span>    onNeedVisualUpdate: ensureVisualUpdate,
</span></span><span style=display:flex><span>    onSemanticsOwnerCreated: _handleSemanticsOwnerCreated,
</span></span><span style=display:flex><span>    onSemanticsOwnerDisposed: _handleSemanticsOwnerDisposed,
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>set</span> renderView(RenderView value) {
</span></span><span style=display:flex><span>  _pipelineOwner.rootNode <span style=color:#f92672>=</span> value;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>PipelineOwner</strong> å…¶å®æ¸²æŸ“ç®¡é“çš„ç®¡ç†è€…ï¼Œå®ƒåœ¨æ¸²æŸ“æµç¨‹ä¸­æœ‰ 3 ä¸ªä¸»è¦çš„æ–¹æ³•ï¼š</p><ol><li><code>flushLayout</code> æ›´æ–°æ‰€æœ‰è„èŠ‚ç‚¹åˆ—è¡¨çš„å¸ƒå±€ä¿¡æ¯</li><li><code>flushCompositionBits</code> å¯¹é‡æ–°è®¡ç®— needsCompositing çš„èŠ‚ç‚¹è¿›è¡Œæ›´æ–°</li><li><code>flushPaint</code> é‡ç»˜æ‰€æœ‰è„èŠ‚ç‚¹</li></ol><p>è¿™ 3 ä¸ªæ–¹æ³•é€šå¸¸æ˜¯æŒ‰é¡ºåºä¸€èµ·ä½¿ç”¨çš„ï¼ŒRenderBiding ä¼šåœ¨ <code>drawFrame()</code> æ–¹æ³•ä¸­è°ƒç”¨è¿™ 3 ä¸ªæ–¹æ³•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// RenderBiding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>@</span>protected
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> drawFrame() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>assert</span>(renderView <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>  pipelineOwner.flushLayout();
</span></span><span style=display:flex><span>  pipelineOwner.flushCompositingBits();
</span></span><span style=display:flex><span>  pipelineOwner.flushPaint();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (sendFramesToEngine) {
</span></span><span style=display:flex><span>    renderView.compositeFrame(); <span style=color:#75715e>// this sends the bits to the GPU
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    pipelineOwner.flushSemantics(); <span style=color:#75715e>// this also sends the semantics to the OS.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    _firstFrameSent <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ç ”ç©¶ä¸€ä¸‹è¿™ 3 ä¸ªæ–¹æ³•åˆ†åˆ«åšäº†ä»€ä¹ˆã€‚</p><h3 id=flushlayout>flushLayout<a hidden class=anchor aria-hidden=true href=#flushlayout>#</a></h3><p>æˆ‘ä»¬çŸ¥é“å½“ RenderObject æœ‰ä¸¤ä¸ªæ ‡è¯†ï¼š</p><ul><li>_needsLayout ç”¨äºæ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–° Layout</li><li>_needsPaint ç”¨äºæ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–°ç»˜åˆ¶</li></ul><p>è¿™ä¸¤ä¸ªå±æ€§æ˜¯ä¿è¯ Render Tree å±€éƒ¨é‡ç»˜çš„å…³é”®å±æ€§ã€‚</p><p>å½“æŸä¸ªèŠ‚ç‚¹éœ€è¦æ›´æ–°å¸ƒå±€ä¿¡æ¯æ—¶ï¼Œä¼šè°ƒç”¨ <code>markNeedsLayout()</code> æ¥é‡ç½® _needsLayoutï¼Œä½†åªè¿™ä¸ªè¿‡ç¨‹è¿˜ä¼šå°†å½“å‰èŠ‚ç‚¹æ·»åŠ åˆ° PipelineOwner çš„ _nodesNeedingLayout ä¸­ï¼ˆ<code>markNeedsPaint</code> åˆ™ä¼šæ·»åŠ åˆ° _nodesNeedingPaintï¼‰ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>// ä»…ä¿ç•™ä¸»è¦ä»£ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> markNeedsLayout() {
</span></span><span style=display:flex><span>  _needsLayout <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (owner <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    owner<span style=color:#f92672>!</span>._nodesNeedingLayout.add(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    owner<span style=color:#f92672>!</span>.requestVisualUpdate();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>flushLayout()</code> ä¼šå°†æ·±åº¦éå†è¿™äº›èŠ‚ç‚¹ï¼Œè°ƒç”¨ RenderObject çš„ <code>_layoutWithoutResize()</code> æ–¹æ³•æ¥é‡æ–° Layoutï¼Œæœ€åå°† _needsLayout ç½®ä¸º false å¹¶è°ƒç”¨ <code>markNeedsPaint()</code> è®©è¯¥èŠ‚ç‚¹éœ€è¦é‡æ–°ç»˜åˆ¶ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// PipelineOwner
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> flushLayout() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åªä¿ç•™ä¸»è¦é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>while</span> (_nodesNeedingLayout.isNotEmpty) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>RenderObject<span style=color:#f92672>&gt;</span> dirtyNodes <span style=color:#f92672>=</span> _nodesNeedingLayout;
</span></span><span style=display:flex><span>    _nodesNeedingLayout <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span>RenderObject<span style=color:#f92672>&gt;</span>[];
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ·±åº¦éå†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (RenderObject node <span style=color:#66d9ef>in</span> dirtyNodes..sort(
</span></span><span style=display:flex><span>      (RenderObject a, RenderObject b) <span style=color:#f92672>=&gt;</span> a.depth <span style=color:#f92672>-</span> b.depth)
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (node._needsLayout <span style=color:#f92672>&amp;&amp;</span> node.owner <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>        node._layoutWithoutResize();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// RenderObject
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>@</span>pragma(<span style=color:#e6db74>&#39;vm:notify-debugger-on-exception&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> _layoutWithoutResize() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    performLayout(); <span style=color:#75715e>// å¸ƒå±€æµ‹é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    markNeedsSemanticsUpdate();
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (e, stack) {
</span></span><span style=display:flex><span>    _debugReportException(<span style=color:#e6db74>&#39;performLayout&#39;</span>, e, stack);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  _needsLayout <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>  markNeedsPaint(); <span style=color:#75715e>// è®©èŠ‚ç‚¹éœ€è¦é‡æ–°ç»˜åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Layout æ˜¯é€šè¿‡ <code>performLayout()</code> æ–¹æ³•å®Œæˆçš„ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ RenderObject é¢„ç•™ç»™å­ç±»å®ç°è‡ªèº« Layout é€»è¾‘çš„æŠ½è±¡æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨ RenderView ä¸­çš„å®ç°å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// RenderView
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> performLayout() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// RenderView éœ€è¦å æ»¡æ•´ä¸ªå±å¹•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// ä½¿ç”¨ ViewConfiguration çš„ size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  _size <span style=color:#f92672>=</span> configuration.size;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (child <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®©å­èŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹çš„å¸ƒå±€çº¦æŸä¸‹è¿›è¡Œ Layout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    child<span style=color:#f92672>!</span>.layout(BoxConstraints.tight(_size));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¦æ³¨æ„çš„æ˜¯ï¼Œè‡ªå®šä¹‰çš„ RenderBox å¦‚æœè¦æ”¾åœ¨èƒ½åŒ…å«å¤šä¸ªå­èŠ‚ç‚¹çš„ RenderBox ä¸­ï¼Œä¾‹å¦‚ RenderFlex å’Œ RenderStackï¼Œé‚£ä¹ˆ<strong>éœ€è¦é‡å†™ <code>performLayout()</code> æ¥ç¡®å®šå¸ƒå±€å¤§å°ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨å¦å¤–ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨çˆ¶èŠ‚ç‚¹çš„æä¾›çš„çº¦æŸæ¥è°ƒæ•´è‡ªå·±çš„å¤§å°ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>get</span> sizedByParent <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>Size computeDryLayout(BoxConstraints constraints) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> constraints.smallest;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>è¿™ä¸ªæ–¹å¼åœ¨æˆ‘ä»¬ä¸‹é¢çš„å®éªŒğŸ§ªä¼šç”¨åˆ°ã€‚</em></p><h3 id=flushcompositingbits>flushCompositingBits<a hidden class=anchor aria-hidden=true href=#flushcompositingbits>#</a></h3><p>åœ¨ <code>flushLayout()</code> æ–¹æ³•åç´§æ¥ç€ä¼šè¢«è°ƒç”¨çš„æ–¹æ³•æ˜¯ <code>flushCompositingBits()</code>ã€‚è¿™ä¸ªæ–¹æ³•ä¼šè¿›è¡Œæ·±åº¦éå†æ›´æ–° _nodesNeedingCompositingBitsUpdate åˆ—è¡¨ä¸­èŠ‚ç‚¹çš„ needsCompositingï¼Œå®ƒä¼šè°ƒç”¨èŠ‚ç‚¹çš„
<code>_updateCompositingBits()</code> æ–¹æ³•å¯¹ RenderObject èŠ‚ç‚¹çš„ä¸€äº›å±æ€§è¿›è¡Œæ›´æ–°ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>_needsCompositing æ˜¯å¦éœ€è¦åˆæˆ layer</li><li>_needsCompositingBitsUpdate æ˜¯å¦éœ€è¦æ›´æ–° _needsCompositing</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// PipelineOwner
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> flushCompositingBits() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åªä¿ç•™ä¸»è¦é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  _nodesNeedingCompositingBitsUpdate.sort(
</span></span><span style=display:flex><span>    (RenderObject a, RenderObject b) <span style=color:#f92672>=&gt;</span> a.depth <span style=color:#f92672>-</span> b.depth);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>final</span> RenderObject node <span style=color:#66d9ef>in</span> _nodesNeedingCompositingBitsUpdate) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (node._needsCompositingBitsUpdate <span style=color:#f92672>&amp;&amp;</span> node.owner <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>      node._updateCompositingBits();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  _nodesNeedingCompositingBitsUpdate.clear();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>kReleaseMode) {
</span></span><span style=display:flex><span>    Timeline.finishSync();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=flushpaint>flushPaint<a hidden class=anchor aria-hidden=true href=#flushpaint>#</a></h3><p><code>flushPaint()</code> æ˜¯ç¬¬ 3 ä¸ªè°ƒç”¨çš„ï¼Œå¯¹ _nodesNeedingPaint ä¸­çš„èŠ‚ç‚¹è¿›è¡Œæ·±åº¦éå†ï¼Œç„¶åè°ƒç”¨èŠ‚ç‚¹çš„ <strong>PaintingContext</strong> çš„é™æ€æ–¹æ³• <code>repaintCompositedChild()</code> é‡æ–°ç»˜åˆ¶ RenderObject çš„è§†å›¾ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// PipelineOwner
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> flushPaint() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åªä¿ç•™ä¸»è¦é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>RenderObject<span style=color:#f92672>&gt;</span> dirtyNodes <span style=color:#f92672>=</span> _nodesNeedingPaint;
</span></span><span style=display:flex><span>  _nodesNeedingPaint <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span>RenderObject<span style=color:#f92672>&gt;</span>[];
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Sort the dirty nodes in reverse order (deepest first).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>final</span> RenderObject node <span style=color:#66d9ef>in</span> dirtyNodes..sort(
</span></span><span style=display:flex><span>    (RenderObject a, RenderObject b) <span style=color:#f92672>=&gt;</span> b.depth <span style=color:#f92672>-</span> a.depth)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (node._needsPaint <span style=color:#f92672>&amp;&amp;</span> node.owner <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (node._layerHandle.layer<span style=color:#f92672>!</span>.attached) {
</span></span><span style=display:flex><span>        PaintingContext.repaintCompositedChild(node);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        node._skippedPaintingOnLayer();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¯¥æ–¹æ³•ä¸­é€šè¿‡å±‚å±‚è°ƒç”¨æœ€ç»ˆä¼šåˆ°è¾¾ï¼Œä¼ å…¥èŠ‚ç‚¹çš„ <code>paint()</code> æ–¹æ³•ã€‚<code>paint()</code> æ–¹æ³•ä¹Ÿæ˜¯ RenderObject æä¾›ç»™å­ç±»å®ç°ç»˜åˆ¶é€»è¾‘çš„æŠ½è±¡æ–¹æ³•ã€‚åŒæ ·ä»¥ RenderView ä¸ºä¾‹å­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// RenderView
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> paint(PaintingContext context, Offset offset) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (child <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>    context.paintChild(child<span style=color:#f92672>!</span>, offset);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç”±äº RenderView æ˜¯æ•´é¢—æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œå› æ­¤æ²¡æœ‰ä»€ä¹ˆç»˜åˆ¶é€»è¾‘ï¼Œä½†æ‰€æœ‰çš„ RenderObject éƒ½ä¸€æ ·ï¼Œå¦‚æœæœ‰å­èŠ‚ç‚¹éƒ½ä¼šé€šè¿‡ PaintingContext ç»§ç»­è°ƒç”¨å­èŠ‚ç‚¹çš„ <code>paint()</code> æ–¹æ³•å¹¶å°† PaintingContext ä¼ é€’ä¸‹å»ï¼Œç›´åˆ°æ•´é¢—æ ‘çš„èŠ‚ç‚¹éƒ½å®Œæˆç»˜åˆ¶ã€‚</p><hr><h2 id=åœºæ™¯åˆæˆä¸ç•Œé¢åˆ·æ–°æ¸²æŸ“>åœºæ™¯åˆæˆä¸ç•Œé¢åˆ·æ–°æ¸²æŸ“<a hidden class=anchor aria-hidden=true href=#åœºæ™¯åˆæˆä¸ç•Œé¢åˆ·æ–°æ¸²æŸ“>#</a></h2><p>æˆ‘ä»¬çŸ¥é“ Widget æœ€ç»ˆéƒ½æ˜¯é€šè¿‡ Canvas è¿›è¡Œç»˜åˆ¶çš„ï¼Œå› æ­¤æˆ‘ä»¬ä»¥ä¸€ä¸ªè‡ªå®šä¹‰ View çš„ä¾‹å­æ¥åšåˆ†æã€‚</p><p>åœ¨ ã€ŠFlutter å®æˆ˜Â·ç¬¬äºŒç‰ˆã€‹ è¿™æœ¬ä¹¦ä¸­ï¼Œæ˜¯ä½¿ç”¨ <code>CustomPainter</code> æ¥ç¼–å†™è‡ªå®šä¹‰ Viewï¼Œé€šè¿‡é‡å†™
<code>void paint(Canvas canvas, Size size);</code> æ–¹æ³•æ¥è·å¾—ä¸€ä¸ª Canvas å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥å¾€è¿™ä¸ªæ–¹æ³•çš„æºç ç¿»é˜…ï¼ŒæŸ¥çœ‹è¿™ä¸ª Canvas å¯¹è±¡çš„æ¥æºã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>// custom_paint.dart
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomPainter</span> <span style=color:#66d9ef>extends</span> Listenable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// Provides a canvas on which to draw during the paint phase.
</span></span></span><span style=display:flex><span><span style=color:#75715e>/// æä¾›äº†åœ¨ç»˜å›¾é˜¶æ®µè¦è¿›è¡Œç»˜åˆ¶çš„ Canvas
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RenderCustomPaint</span> <span style=color:#66d9ef>extends</span> RenderProxyBox {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> _paintWithPainter(Canvas canvas, Offset offset, CustomPainter painter) {
</span></span><span style=display:flex><span>  	<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// åœ¨è¿™é‡Œè°ƒç”¨ CustomPainter çš„ paintï¼Œå¹¶æä¾›ä¸€ä¸ª Canvas å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	painter.paint(canvas, size);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> paint(PaintingContext context, Offset offset) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (_painter <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// è¿™é‡Œæä¾› canvas
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      _paintWithPainter(context.canvas, offset, _painter<span style=color:#f92672>!</span>);
</span></span><span style=display:flex><span>      _setRasterCacheHints(context);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>.paint(context, offset);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (_foregroundPainter <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>      _paintWithPainter(context.canvas, offset, _foregroundPainter<span style=color:#f92672>!</span>);
</span></span><span style=display:flex><span>      _setRasterCacheHints(context);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ View çš„ç»˜åˆ¶æ“ä½œï¼Œæ˜¯ç”± <strong>RenderCustomPaint</strong> æ‰§è¡Œï¼Œå®ƒçš„æœ¬è´¨å…¶å®æ˜¯ä¸€ä¸ª <strong>RenderBox</strong>ï¼Œè€Œå…¶ä¸­ä¼ å…¥çš„ Canvas å¯¹è±¡æ˜¯ç”±å®ƒåœ¨ <code>paint()</code> ä¸­çš„ PaintingContext æä¾›çš„ã€‚</p><h3 id=canvas-ä¸ç»˜åˆ¶å­˜å‚¨>Canvas ä¸ç»˜åˆ¶å­˜å‚¨<a hidden class=anchor aria-hidden=true href=#canvas-ä¸ç»˜åˆ¶å­˜å‚¨>#</a></h3><p>åœ¨ PaintingContext ä¸­æ˜¯é‡‡ç”¨æ‡’åŠ è½½çš„æ–¹å¼æ¥åˆ›å»º Canvas å¯¹è±¡ï¼ŒPaintingContext ä¸€èˆ¬åˆ›å»ºäº Render Tree çš„å•ç‹¬å­æ ‘å¼€å§‹ç»˜åˆ¶æ—¶ï¼Œåˆ›å»ºæ—¶ä¼šé™„å¸¦åˆ›å»ºå¦å¤–ä¸¤ä¸ªå¯¹è±¡ï¼š</p><ul><li>PictureLayer å›¾å±‚</li><li>PictureRecorder å›¾åƒè®°å½•è€…</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>// object.dart
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PaintingContext</span> <span style=color:#66d9ef>extends</span> ClipContext {
</span></span><span style=display:flex><span>  Canvas<span style=color:#f92672>?</span> _canvas;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/// è·å– Canvas å¯¹è±¡ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// å½“ _canvas æ²¡æœ‰åˆ›å»ºæ—¶è°ƒç”¨ [_startRecording] æ–¹æ³•åˆ›å»º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  Canvas <span style=color:#66d9ef>get</span> canvas {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (_canvas <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>      _startRecording();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span>(_currentLayer <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _canvas<span style=color:#f92672>!</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/// åˆ›å»º Canvas å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// - åˆ›å»º PictureLayer å›¾å±‚å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// - åˆ›å»º PictureRecorder å›¾åƒè®°å½•è€…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// - åˆ›å»º Canvas å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// - å°† PictureLayer æ·»åŠ åˆ° ContainerLayer å®¹å™¨å±‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>void</span> _startRecording() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span>(<span style=color:#f92672>!</span>_isRecording);
</span></span><span style=display:flex><span>    _currentLayer <span style=color:#f92672>=</span> PictureLayer(estimatedBounds);
</span></span><span style=display:flex><span>    _recorder <span style=color:#f92672>=</span> ui.PictureRecorder();
</span></span><span style=display:flex><span>    _canvas <span style=color:#f92672>=</span> Canvas(_recorder<span style=color:#f92672>!</span>);
</span></span><span style=display:flex><span>    _containerLayer.append(_currentLayer<span style=color:#f92672>!</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åˆ›å»º Canvas æ—¶å¿…é¡»ä¼ å…¥ä¸€ä¸ª PictureRecorder å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè®°å½• Canvas çš„ç»˜åˆ¶æ“ä½œï¼Œå½“å®Œæˆè®°å½•æ—¶ï¼Œå¯é€šè¿‡è°ƒç”¨ <code>PictureRecord.endRecording</code> æ¥ç»“æŸè®°å½•ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ª Picture å¯¹è±¡ï¼Œç”±äº Canvas çš„ç»˜åˆ¶æ˜¯ç”± Engine å±‚ä¸­çš„ Skia å¼•æ“æä¾›ï¼Œå› æ­¤ Picture å¯¹è±¡ä¹Ÿæ˜¯å­˜å‚¨åœ¨ Engine å±‚ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// PictureRecorder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Picture endRecording() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (_canvas <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> StateError(<span style=color:#e6db74>&#39;PictureRecorder did not start recording.&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Picture picture <span style=color:#f92672>=</span> Picture._();
</span></span><span style=display:flex><span>  _endRecording(picture);
</span></span><span style=display:flex><span>  _canvas<span style=color:#f92672>!</span>._recorder <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  _canvas <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> picture;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> _endRecording(Picture outPicture) <span style=color:#66d9ef>native</span> <span style=color:#e6db74>&#39;PictureRecorder_endRecording&#39;</span>;
</span></span></code></pre></div><h3 id=layer-tree>Layer Tree<a hidden class=anchor aria-hidden=true href=#layer-tree>#</a></h3><p><code>_startRecording()</code> é™¤äº†åˆ›å»º Canvas å’Œ PictureRecorder å¤–ï¼Œè¿˜åˆ›å»ºäº†ä¸€ä¸ª PictureLayer å¯¹è±¡å¹¶å°†å®ƒåŠ å…¥åˆ°äº† _containerLayer ä¸­ã€‚è¿™ä¸ª _containerLayer å…¶å®æ˜¯ RenderObject ä¸­çš„ä¸€ä¸ª Layerã€‚</p><p>Layer æ˜¯ç”¨äºç¼“å­˜ç»˜å›¾æ“ä½œç»“æœï¼ˆPictureï¼‰çš„å›¾å±‚ï¼Œå›¾å±‚å¯ä»¥æŒ‰ç…§è§„åˆ™è¿›è¡Œæ’åˆ—å¾—åˆ°å›¾åƒã€‚æ¯ä¸ª RenderObject ä¸­ä¼šéƒ½æœ‰ä¸€ä¸ª Layerï¼Œå­˜å‚¨åœ¨ LayerHandle ä¸­ï¼Œ<strong>Render Tree æ‰§è¡Œ flushPaint å®Œæˆç»˜åˆ¶åï¼Œä¼šå½¢æˆä¸€é¢— Layer Treeï¼ŒLayer Tree çš„èŠ‚ç‚¹æ•°é‡ä¼šæ¯” Render Tree å°‘ï¼Œå‡ ä¸ª RenderObject èŠ‚ç‚¹åªå¯¹åº”ä¸€ä¸ª Layer èŠ‚ç‚¹ã€‚</strong></p><p>Layer èŠ‚ç‚¹ä¹Ÿæœ‰å¤šç§ï¼Œä½†ç”¨çš„æœ€å¤šçš„æ˜¯ä»¥ä¸‹ä¸¤ç§ï¼š</p><ul><li>ä½¿ç”¨ PictureRecorder è®°å½•ç»˜å›¾æ“ä½œçš„èŠ‚ç‚¹ä½¿ç”¨ PictureLayerï¼ŒPictureLayer ä¸å…·æœ‰å­èŠ‚ç‚¹ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„å¶å­èŠ‚ç‚¹ç±»å‹</li><li>å½“éœ€è¦å’Œ Layer å­èŠ‚ç‚¹è¿›è¡Œå åŠ æ¥å¾—åˆ°å›¾åƒæ—¶ï¼Œå¯ä½¿ç”¨ ContainerLayerï¼Œå®ƒæä¾›äº† append æ–¹æ³•æ¥è¿æ¥ Layerï¼Œä»¥å½¢æˆä¸€é¢— Layer Treeã€‚</li></ul><p>ContainerLayer å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œå®ƒä»¬ä»¥é“¾è¡¨çš„æ–¹å¼è¿æ¥åœ¨ä¸€èµ·ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨ ContainerLayerï¼Œè€Œæ˜¯ä½¿ç”¨å®ƒçš„å­ç±» OffsetLayerã€‚</p><blockquote><p>ä½¿ç”¨ <code>prepareInitialFrame()</code> æ–¹æ³•åˆå§‹åŒ– RenderView åˆ›å»ºçš„ Layer ç±»å‹æ˜¯ <strong>TransformLayer</strong> ï¼Œå®ƒä¹Ÿæ˜¯ OffsetLayer çš„å­ç±»ã€‚</p></blockquote><p>å½“åˆ›å»º PaintingContext æ—¶æä¾›çš„ Layer èŠ‚ç‚¹ä¸å±äº OffsetLayer æ—¶ ï¼Œä¼šåˆ›å»ºä¸€ä¸ª OffsetLayer æ¥ä»£æ›¿åŸæœ¬çš„ Layerï¼Œä½œä¸ºå½“å‰å­æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚ PaintingContext åˆ›å»ºæ–°çš„ PictureLayer æ—¶å°†ä¼šä½¿ç”¨ append æ–¹æ³•å°†æ–°çš„ Layer èŠ‚ç‚¹æ·»åŠ åˆ°è¿™ä¸ª OffsetLayer ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// PaintingContext
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> _repaintCompositedChild(
</span></span><span style=display:flex><span>  RenderObject child, {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> debugAlsoPaintedParent <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    PaintingContext<span style=color:#f92672>?</span> childContext,
</span></span><span style=display:flex><span>  }) {
</span></span><span style=display:flex><span>  OffsetLayer<span style=color:#f92672>?</span> childLayer <span style=color:#f92672>=</span> child._layerHandle.layer <span style=color:#f92672>as</span> OffsetLayer<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (childLayer <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> OffsetLayer layer <span style=color:#f92672>=</span> OffsetLayer();
</span></span><span style=display:flex><span>    child._layerHandle.layer <span style=color:#f92672>=</span> childLayer <span style=color:#f92672>=</span> layer;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    childLayer.removeAllChildren();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åœ¨è¿™é‡Œåˆ›å»º PaintingContext
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  childContext <span style=color:#f92672>??=</span> PaintingContext(childLayer, child.paintBounds);
</span></span><span style=display:flex><span>  child._paintWithContext(childContext, Offset.zero);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å®Œæˆç»˜åˆ¶ç»“æŸè®°å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  childContext.stopRecordingIfNeeded();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸Šé¢æåˆ°å¦‚æœèŠ‚ç‚¹æœ‰å­©å­ï¼Œä¼šé€šè¿‡ <code>context.paintChild()</code> è®©å­èŠ‚ç‚¹ä¹Ÿè°ƒç”¨ <code>_paintWithContext()</code> æ–¹æ³•å°† PaintingContext å‘ä¸‹ä¼ é€’ï¼Œç»§ç»­æ‰§è¡Œå­èŠ‚ç‚¹çš„ <code>paint()</code> æ–¹æ³•è¿›è¡Œç»˜åˆ¶ã€‚</p><p>å½“ç›®å‰çš„å›¾å±‚ç»˜åˆ¶å®Œæˆæ—¶ï¼Œç»˜åˆ¶å®Œæˆæ—¶ä¼šè°ƒç”¨ <code>stopRecordingIfNeeded()</code> æ¥ç»“æŸè®°å½•ç»˜åˆ¶ï¼Œå¹¶å°† PictureRecord ç”Ÿæˆçš„ Picture å¯¹è±¡ç¼“å­˜åˆ° PictureLayer ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// PaintingContext
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>@</span>protected
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>mustCallSuper
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> stopRecordingIfNeeded() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>_isRecording)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  _currentLayer<span style=color:#f92672>!</span>.picture <span style=color:#f92672>=</span> _recorder<span style=color:#f92672>!</span>.endRecording();
</span></span><span style=display:flex><span>  _currentLayer <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  _recorder <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  _canvas <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// PictureLayer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>set</span> picture(ui.Picture<span style=color:#f92672>?</span> picture) {
</span></span><span style=display:flex><span>  markNeedsAddToScene();
</span></span><span style=display:flex><span>  _picture<span style=color:#f92672>?</span>.dispose();
</span></span><span style=display:flex><span>  _picture <span style=color:#f92672>=</span> picture;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=èŠ‚ç‚¹çš„ç»˜åˆ¶åˆ†ç¦»>èŠ‚ç‚¹çš„ç»˜åˆ¶åˆ†ç¦»<a hidden class=anchor aria-hidden=true href=#èŠ‚ç‚¹çš„ç»˜åˆ¶åˆ†ç¦»>#</a></h3><p>Render Tree çš„ç»˜åˆ¶æ˜¯é‡‡ç”¨æ·±åº¦éå†è‡ªé¡¶å‘ä¸‹ç»˜åˆ¶çš„ï¼Œå³å½“å‰èŠ‚ç‚¹ç»˜åˆ¶å®Œè°ƒç”¨å­èŠ‚ç‚¹çš„ç»˜åˆ¶æ–¹æ³•ã€‚</p><p>RenderObject æä¾›äº† <strong>isRepaintBoundary</strong> å±æ€§æ¥åˆ¤æ–­å½“å‰å­æ ‘æ˜¯å¦éœ€è¦ä¸çˆ¶èŠ‚ç‚¹åˆ†å¼€ç»˜åˆ¶ï¼Œè¯¥å±æ€§é»˜è®¤ä¸º falseï¼Œå¹¶ä¸”æ²¡æœ‰ setter æ¥è¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹ä¸€é¢— Render Tree å¯èƒ½åªä¼šç”Ÿæˆ 2 ä¸ª Layer èŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹çš„ TransformLayer å’Œå­˜å‚¨ç»˜åˆ¶ç»“æœçš„ PictureLayoutï¼‰ã€‚</p><p>ä½†å…¶å®æˆ‘ä»¬å¯ä»¥åœ¨ RenderBox çš„å­ç±»é‡å†™è¯¥å±æ€§ï¼Œæˆ–è€…ä½¿ç”¨ RenderRepaintBoundaryï¼ˆå®ƒçš„ isRepaintBoundary è¢«é‡å†™ä¸º trueï¼‰ï¼Œæ¥åˆ†ç¦»çˆ¶å­èŠ‚ç‚¹çš„ç»˜åˆ¶ï¼Œä»è¾¾åˆ°åˆ†å¼€ç»˜åˆ¶ç”Ÿæˆä¸åŒ Layer èŠ‚ç‚¹å½¢æˆä¸€é¢— Layer Treeã€‚</p><p>è¯¥å±æ€§åœ¨ <code>markNeedsPaint()</code>æ–¹æ³•ä¸­ä¹Ÿæœ‰ä½¿ç”¨ï¼Œç›¸å…³æºç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>void</span> markNeedsPaint() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (_needsPaint)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  _needsPaint <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  markNeedsPaintCout<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (isRepaintBoundary) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (owner <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      owner<span style=color:#f92672>!</span>._nodesNeedingPaint.add(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>      owner<span style=color:#f92672>!</span>.requestVisualUpdate();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (parent <span style=color:#66d9ef>is</span> RenderObject) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> RenderObject parent <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.parent<span style=color:#f92672>!</span> <span style=color:#f92672>as</span> RenderObject;
</span></span><span style=display:flex><span>    parent.markNeedsPaint();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>å¦‚æœ isRepaintBoundary ä¸º true åˆ™è¡¨ç¤ºå’Œçˆ¶èŠ‚ç‚¹åˆ†å¼€ç»˜åˆ¶ï¼Œå°†è‡ªå·±æ·»åŠ åˆ° _nodesNeedingPaint åˆ—è¡¨ä¸­ï¼Œåœ¨ä¸‹ä¸€æ¬¡æ›´æ–°æ—¶å°±åªä¼šé‡ç»˜å½“å‰å­æ ‘ï¼Œä¸ä¼šæ±¡æŸ“åˆ°çˆ¶èŠ‚ç‚¹ã€‚</li><li>å¦‚æœ isRepaintBoundary ä¸º false åˆ™è°ƒç”¨çˆ¶èŠ‚ç‚¹çš„ <code>markNeedsPaint()</code>æ¥è®©çˆ¶èŠ‚ç‚¹å¤„ç†ï¼Œä¸‹ä¸€æ¬¡æ›´æ–°ç”±çˆ¶èŠ‚ç‚¹é‡ç»˜æ—¶æ‰§è¡Œè‡ªå·±çš„ç»˜åˆ¶æ–¹æ³•è¿›è¡Œé‡ç»˜ã€‚</li></ul><p>è€Œåœ¨ç»˜åˆ¶æµç¨‹ä¸­ï¼Œå¦‚æœå­èŠ‚ç‚¹çš„ isRepaintBoundary ä¸º trueï¼Œä»£è¡¨éœ€è¦åˆ†å¼€ç»˜åˆ¶ï¼Œä¼šç»“æŸå½“å‰ PictureRecorder çš„è®°å½•å¹¶å°†ç”Ÿæˆçš„ Picture å­˜åˆ° Layer ä¸­ï¼Œç„¶åå¼€å§‹å­èŠ‚ç‚¹çš„ç»˜åˆ¶ã€‚</p><p>å­èŠ‚ç‚¹ç»˜åˆ¶æ—¶ç”±äº PaintingContext çš„ Layer å·²ç»è¢«è®¾ç½®ä¸º null äº†ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºæ–°çš„ PictureLayer å¹¶æ·»åŠ åˆ°æ ¹ Layer çš„å­èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¦‚æœå­èŠ‚ç‚¹ä¸éœ€è¦é‡æ–°ç»˜åˆ¶ï¼Œå°±ç›´æ¥å°†å­èŠ‚ç‚¹çš„ Layer æ·»åŠ åˆ°æ ¹ Layer çš„å­èŠ‚ç‚¹åˆ—è¡¨ã€‚</p><p>è¿™é‡Œæ·»åŠ æ—¶ä½¿ç”¨çš„ <code>appendLayer()</code> ä¼šå…ˆå°†å½“å‰çš„ Layer èŠ‚ç‚¹ä»åŸæœ¬çš„çˆ¶èŠ‚ç‚¹ä¸­ç§»é™¤ï¼Œå†è¿›è¡Œæ·»åŠ ï¼Œå› æ­¤ä¸ç”¨å½“å¿ƒä¼šå‡ºç°é‡å¤æ·»åŠ çš„æƒ…å†µï¼Œç”±äºå­èŠ‚ç‚¹åˆ—è¡¨çš„æœ¬è´¨æ˜¯é“¾è¡¨ï¼Œè€Œä¸”åˆ›å»ºåæ·»åŠ ä¸å†æ·»åŠ ä¹‹é—´é€šå¸¸ä¸ä¼šæœ‰å…¶å®ƒ Layer èŠ‚ç‚¹ä»‹å…¥ï¼Œå› æ­¤ä¹Ÿä¸éœ€è¦å½“å¿ƒè¯¥æ–¹æ³•æ·»åŠ æ—¶çš„ç§»åŠ¨å’ŒæŸ¥æ‰¾æ•ˆç‡ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// PaintingContext
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> paintChild(RenderObject child, Offset offset) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (child.isRepaintBoundary) {
</span></span><span style=display:flex><span>    stopRecordingIfNeeded(); <span style=color:#75715e>// ç»“æŸå½“å‰æ ‘çš„ç»˜åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    _compositeChild(child, offset);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    child._paintWithContext(<span style=color:#66d9ef>this</span>, offset);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// çœç•¥äº†å¾ˆå¤šä»£ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> _compositeChild(RenderObject child, Offset offset) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create a layer for our child, and paint the child into it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (child._needsPaint) {
</span></span><span style=display:flex><span>      repaintCompositedChild(child, debugAlsoPaintedParent: <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> OffsetLayer childOffsetLayer <span style=color:#f92672>=</span> child._layerHandle.layer<span style=color:#f92672>!</span> <span style=color:#f92672>as</span> OffsetLayer;
</span></span><span style=display:flex><span>    childOffsetLayer.offset <span style=color:#f92672>=</span> offset;
</span></span><span style=display:flex><span>    appendLayer(childOffsetLayer);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>protected
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> appendLayer(Layer layer) {
</span></span><span style=display:flex><span>  layer.remove(); <span style=color:#75715e>// ä»çˆ¶èŠ‚ç‚¹ä¸­ç§»é™¤å½“å‰èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  _containerLayer.append(layer);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=åœºæ™¯æ¸²æŸ“>åœºæ™¯æ¸²æŸ“<a hidden class=anchor aria-hidden=true href=#åœºæ™¯æ¸²æŸ“>#</a></h3><p>æˆ‘ä»¬å›åˆ° RenderBinding çš„ <code>drawFrame()</code> æ–¹æ³•ä¸­ï¼Œçœ‹ä¸€ä¸‹ Render Tree å®Œæˆç»˜åˆ¶åï¼Œæ˜¯å¦‚ä½•æ¸²æŸ“åˆ°ç•Œé¢çš„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// RenderBiding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>@</span>protected
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> drawFrame() {
</span></span><span style=display:flex><span>  pipelineOwner.flushLayout();
</span></span><span style=display:flex><span>  pipelineOwner.flushCompositingBits();
</span></span><span style=display:flex><span>  pipelineOwner.flushPaint();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (sendFramesToEngine) {
</span></span><span style=display:flex><span>    renderView.compositeFrame(); <span style=color:#75715e>// this sends the bits to the GPU
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    pipelineOwner.flushSemantics(); <span style=color:#75715e>// this also sends the semantics to the OS.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    _firstFrameSent <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// RenderView
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> compositeFrame() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> ui.SceneBuilder builder <span style=color:#f92672>=</span> ui.SceneBuilder();
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å°†å›¾å±‚æ·»åŠ åˆ° scene
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>final</span> ui.Scene scene <span style=color:#f92672>=</span> layer<span style=color:#f92672>!</span>.buildScene(builder);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å‘é€ scene ç»™ GPU è¿›è¡Œæ¸²æŸ“
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  _window.render(scene);
</span></span><span style=display:flex><span>  scene.dispose();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// Layer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>ui.Scene buildScene(ui.SceneBuilder builder) {
</span></span><span style=display:flex><span>  updateSubtreeNeedsAddToScene();
</span></span><span style=display:flex><span>  addToScene(builder); <span style=color:#75715e>// æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  _needsAddToScene <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> ui.Scene scene <span style=color:#f92672>=</span> builder.build();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> scene;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å½“éœ€è¦å‘é€å¸§å›¾åƒç»™ GPU æ—¶ï¼Œä¼šè°ƒç”¨ <code>compositeFrame()</code> æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šæ„å»ºä¸€ä¸ª SceneBuilderï¼Œç„¶åé€šè¿‡ <code>ContainerLayer.buildScene()</code> å°† Layer Tree çš„ Picture åˆæˆä¸€ä¸ª Sceneã€‚</p><p>Scene å¯ç†è§£ä¸ºåœºæ™¯ï¼Œæ˜¯å­˜å‚¨ GPU ç»˜åˆ¶çš„åƒç´ ä¿¡æ¯çš„å›¾åƒå¯¹è±¡ï¼Œå½“æ·»åŠ çš„æ˜¯ OffsetLayer ä¼šè®¾ç½®å›¾å±‚çš„åç§»é‡ï¼Œå½“æ·»åŠ çš„æ˜¯ ContanierLayer æ—¶ä¼šéå†å­èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ï¼Œå½“æ·»åŠ çš„æ˜¯ PictureLayer ä¼šè°ƒç”¨ native æ–¹æ³•åœ¨ Engine æ·»åŠ  Picture åˆ°å›¾åƒä¸­ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ build æ–¹æ³•æ—¶ä¹Ÿæ˜¯ä» Engine å¾—åˆ° Scene å¯¹è±¡ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>void</span> _addPicture(<span style=color:#66d9ef>double</span> dx, <span style=color:#66d9ef>double</span> dy, Picture picture, <span style=color:#66d9ef>int</span> hints)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>native</span> <span style=color:#e6db74>&#39;SceneBuilder_addPicture&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> _build(Scene outScene) <span style=color:#66d9ef>native</span> <span style=color:#e6db74>&#39;SceneBuilder_build&#39;</span>;
</span></span></code></pre></div><p>Layer ä¸­æœ‰ä¸¤ä¸ªå±æ€§ _needsAddToScene å’Œ _subtreeNeedsAddToScene æ¥è¡¨ç¤ºè‡ªå·±å’Œå­æ ‘æ˜¯å¦éœ€è¦è¢«æ·»åŠ åˆ° Scene ä¸­ï¼Œå½“ Layer è¢«è„äº†åˆ™éœ€è¦åˆæˆåˆ° Sceneï¼Œä¸€ä¸ª Layer æˆ–è€…å…¶å­æ ‘è¢«åˆæˆåˆ° Scene åï¼Œå¯¹åº”çš„å±æ€§ä¼šè¢«è®¾ç½®ä¸º falseã€‚</p><p>Scene åˆæˆå®Œæˆåï¼Œæ¥ç€è°ƒç”¨ <strong>render</strong> æ–¹æ³•å°† Scene å‘é€ç»™ GUP æ¸²æŸ“åˆ°ç•Œé¢ä¸Šã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// FlutterView
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> render(Scene scene) <span style=color:#f92672>=&gt;</span> _render(scene, <span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> _render(Scene scene, FlutterView view) <span style=color:#66d9ef>native</span> <span style=color:#e6db74>&#39;PlatformConfiguration_render&#39;</span>;
</span></span></code></pre></div><h3 id=ç•Œé¢åˆ·æ–°>ç•Œé¢åˆ·æ–°<a hidden class=anchor aria-hidden=true href=#ç•Œé¢åˆ·æ–°>#</a></h3><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ Flutter æ˜¯è°ƒç”¨ <code>drawFrame()</code> æ–¹æ³•ï¼Œæ¥åš Render Tree çš„ç»˜åˆ¶ï¼Œé‚£ä¹ˆ <code>drawFrame()</code> ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢ï¼Ÿæˆ‘ä»¬é˜…è¯»ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// This method is called by [handleDrawFrame], which itself is called
</span></span></span><span style=display:flex><span><span style=color:#75715e>/// automatically by the engine when it is time to lay out and paint a frame.
</span></span></span></code></pre></div><p>æ³¨é‡Šä¸­è¯´æ˜ <code>drawFrame()</code> ä¼šåœ¨ Engine éœ€è¦æä¾›ä¸€å¸§æ–°å›¾åƒæ—¶ï¼Œè‡ªåŠ¨è¢« <code>handleDrawFrame()</code> æ–¹æ³•è°ƒç”¨ï¼Œå®é™…ä¸Šåœ¨ RenderBinding åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šæŠŠè¿™ä¸ªæ–¹æ³•æ·»åŠ åˆ° persistentCallbacks å›è°ƒåˆ—è¡¨ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// RenderBinding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> initInstances() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// window çš„åˆå§‹åŒ–æ—¶ä¼šè®¾ç½®ä¸€äº›çŠ¶æ€æ”¹å˜çš„å›è°ƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  window
</span></span><span style=display:flex><span>      ..onMetricsChanged <span style=color:#f92672>=</span> handleMetricsChanged
</span></span><span style=display:flex><span>      ..onTextScaleFactorChanged <span style=color:#f92672>=</span> handleTextScaleFactorChanged
</span></span><span style=display:flex><span>      ..onPlatformBrightnessChanged <span style=color:#f92672>=</span> handlePlatformBrightnessChanged
</span></span><span style=display:flex><span>      ..onSemanticsEnabledChanged <span style=color:#f92672>=</span> _handleSemanticsEnabledChanged
</span></span><span style=display:flex><span>      ..onSemanticsAction <span style=color:#f92672>=</span> _handleSemanticsAction;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// RenderView åˆå§‹åŒ–åˆ›å»º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  initRenderView();
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åœ¨è¿™é‡Œæ·»åŠ äº†ä¸€ä¸ªå›è°ƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  addPersistentFrameCallback(_handlePersistentFrameCallback);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> _handlePersistentFrameCallback(Duration timeStamp) {
</span></span><span style=display:flex><span>  drawFrame(); <span style=color:#75715e>// åœ¨è¿™ä¸ªå›è°ƒé‡Œè°ƒç”¨å¸§ç»˜åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  _scheduleMouseTrackerUpdate();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// SchedulerBinding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// è¯¥åˆ—è¡¨ä¸­çš„å›è°ƒæ–¹æ³•ä¼šè¢« handleDrawFrame ä¾æ¬¡æ‹¿å‡ºæ¥æ‰§è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>FrameCallback<span style=color:#f92672>&gt;</span> _persistentCallbacks <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span>FrameCallback<span style=color:#f92672>&gt;</span>[];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// å°†å›è°ƒæ·»åŠ åˆ° _persistentCallbacks ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> addPersistentFrameCallback(FrameCallback callback) {
</span></span><span style=display:flex><span>  _persistentCallbacks.add(callback);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>handleDrawFrame()</code> è¢«æ‰§è¡Œæ—¶ï¼Œä¼šä»å›è°ƒåˆ—è¡¨é‡Œé¢å–å‡ºè¿™ä¸ªå›è°ƒï¼Œä»è€Œå±å¹•åˆ·æ–°çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨
<code>drawFrame()</code> å°† Render Tree ç»˜åˆ¶åˆ°ç•Œé¢ä¸Šã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// Engine è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥æä¾›æ–°çš„ä¸€å¸§å›¾åƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> handleDrawFrame() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// PERSISTENT FRAME CALLBACKS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  _schedulerPhase <span style=color:#f92672>=</span> SchedulerPhase.persistentCallbacks;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>final</span> FrameCallback callback <span style=color:#66d9ef>in</span> _persistentCallbacks)
</span></span><span style=display:flex><span>    _invokeFrameCallback(callback, _currentFrameTimeStamp<span style=color:#f92672>!</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ... åªä¿ç•™å…³é”®ä»£ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç•Œé¢åˆ·æ–°æ—¶ï¼Œç›¸å…³çš„å›è°ƒå·¥ä½œä¼šäº¤ç»™ <code>handleDrawFrame()</code> å»æ‰§è¡Œï¼Œè€Œè¿™ä¸ªæ–¹æ³•é™¤äº†åœ¨ APP å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå…ˆåœ¨ <code>scheduleWarmUpFrame()</code> çš„å®šæ—¶å™¨ä¸­æ‰§è¡Œä¸€æ¬¡è¿›è¡Œé¦–æ¬¡å±•ç¤ºå¤–ï¼Œåœ¨ <code>scheduleAttachRootWidget()</code> æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±ä¼šè¢«æ³¨å†Œåˆ° <code>window.onDrawFrame</code>äº†ä½œä¸ºç•Œé¢åˆ·æ–°çš„å›è°ƒäº†ã€‚
æˆ‘ä»¬é‡‡ç”¨æ–­ç‚¹è°ƒè¯•çš„æ–¹å¼ï¼Œå¯ä»¥çœ‹åˆ° APP å¯åŠ¨çš„æ—¶å€™è¿™ä¸ªæ–¹æ³•çš„æ³¨å†Œè°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p><p><img loading=lazy src=./01.png alt=æ³¨å†Œè°ƒç”¨é“¾.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>void</span> runApp(Widget app) {
</span></span><span style=display:flex><span>  WidgetsFlutterBinding.ensureInitialized()
</span></span><span style=display:flex><span>    ..scheduleAttachRootWidget(app) <span style=color:#75715e>// æå‰æ³¨å†Œå›è°ƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ..scheduleWarmUpFrame();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> attachRootWidget(Widget rootWidget) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å¦‚æœæ˜¯å¼•å¯¼å¸§ï¼Œåˆ™è¿›è¡Œè§†è§‰æ›´æ–°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (isBootstrapFrame) {
</span></span><span style=display:flex><span>    SchedulerBinding.instance<span style=color:#f92672>!</span>.ensureVisualUpdate();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> ensureVisualUpdate() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (schedulerPhase) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SchedulerPhase.idle:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SchedulerPhase.postFrameCallbacks:
</span></span><span style=display:flex><span>      scheduleFrame(); <span style=color:#75715e>// &lt;- å¸§ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SchedulerPhase.transientCallbacks:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SchedulerPhase.midFrameMicrotasks:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SchedulerPhase.persistentCallbacks:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// ä»¥ä¸‹éƒ½æ˜¯ SchedulerBinding ä¸­çš„æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> scheduleFrame() {
</span></span><span style=display:flex><span>  ensureFrameCallbacksRegistered(); <span style=color:#75715e>// &lt;- ç¡®å®šå›è°ƒçš„æ³¨å†Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  window.scheduleFrame(); <span style=color:#75715e>// è¯·æ±‚å›è°ƒçš„æ‰§è¡Œï¼Œè¿›è¡Œç•Œé¢æ›´æ–°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  _hasScheduledFrame <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>protected
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> ensureFrameCallbacksRegistered() {
</span></span><span style=display:flex><span>  window.onBeginFrame <span style=color:#f92672>??=</span> _handleBeginFrame;
</span></span><span style=display:flex><span>  window.onDrawFrame <span style=color:#f92672>??=</span> _handleDrawFrame; <span style=color:#75715e>// &lt;- æ³¨å†Œå›è°ƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>æ³¨å†Œçš„è¿™ä¸ªå›è°ƒå…¶å®å°±æ˜¯å¯¹ handleDrawFrame åŒ…äº†ä¸€å±‚å£³ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>void</span> _handleDrawFrame() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (_rescheduleAfterWarmUpFrame) {
</span></span><span style=display:flex><span>    _rescheduleAfterWarmUpFrame <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    addPostFrameCallback((Duration timeStamp) {
</span></span><span style=display:flex><span>      _hasScheduledFrame <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      scheduleFrame();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  handleDrawFrame();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>window.scheduleFrame()</code> ä¼šå‘ Engine å±‚å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨ä¸‹ä¸€æ¬¡åˆé€‚çš„æ—¶æœºè°ƒç”¨<code>window.onDrawFrame</code>å’Œ <code>window.onBeginFrame</code>æ³¨å†Œçš„å›è°ƒï¼Œä»è€Œåˆ·æ–°ç•Œé¢ã€‚</p><p>æœ€åæˆ‘ä»¬é‡‡ç”¨æ–­ç‚¹è°ƒè¯•çš„æ–¹å¼ï¼Œçœ‹ç•Œé¢åˆ·æ–°æ—¶ drawFrame çš„å®Œæ•´è°ƒç”¨é“¾æ˜¯ä»€ä¹ˆæ ·ï¼Œç»¿æ¡†ä¸­çš„å°±æ˜¯æˆ‘ä»¬åˆšåˆšæ‰€è®²åˆ°çš„é‚£äº›æ–¹æ³•äº†ã€‚</p><p><img loading=lazy src=./02.png alt=drawFrameè°ƒç”¨é“¾></p><p>åˆ°è¿™é‡Œï¼ŒçŸ¥è¯†å°±ä¸²èµ·æ¥äº†ï½</p><hr><h2 id=æ•´ç†å›¾>æ•´ç†å›¾<a hidden class=anchor aria-hidden=true href=#æ•´ç†å›¾>#</a></h2><p>æˆ‘ä»¬ç”»å¼ å›¾æ•´ç†ä¸€ä¸‹ï¼Œä¸ºäº†è®©å›¾æ›´åŠ ç®€å•æ˜“çœ‹ï¼Œæˆ‘ä»¬çœç•¥æ‰äº¿ç‚¹ç‚¹ç»†èŠ‚ğŸ¤ã€‚</p><p><img loading=lazy src=./yuque_diagram_1.jpg alt=yuque_diagram_1></p><hr><h2 id=framework-é¡¹ç›®ä»£ç å®éªŒ>Framework é¡¹ç›®ä»£ç å®éªŒ<a hidden class=anchor aria-hidden=true href=#framework-é¡¹ç›®ä»£ç å®éªŒ>#</a></h2><p>å½“ç„¶äº†è§£å®Œç›¸å…³æµç¨‹ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ Flutter Framework çš„é¡¹ç›®ä¸­è¿›è¡Œå®éªŒï¼ŒæŒ‰ç…§æµç¨‹è‡ªå·±å†™ä¸€éä» Render Tree åˆ°ç•Œé¢åˆ·æ–°çš„ä»£ç ï¼Œè¯æ˜ã€ä¹Ÿæ˜¯ç†Ÿæ‚‰è¿™ä¸ªæµç¨‹ã€‚</p><p>é¦–å…ˆæ ¹æ®å®˜æ–¹è¯´æ˜é…ç½®ä¸€ä¸ª Framework å¼€å‘ç¯å¢ƒï¼Œç„¶åè¿›å…¥åˆ° hello_world é¡¹ç›®ä¸­ï¼š
<a href=https://github.com/flutter/flutter/wiki/Setting-up-the-Framework-development-environment>https://github.com/flutter/flutter/wiki/Setting-up-the-Framework-development-environment</a></p><p>å®éªŒé¡¹ç›®å’Œå¹³æ—¶å¼€å‘ä¸€æ ·ä¾æ—§é‡‡ç”¨ Flutter APP çš„æ–¹å¼å¯åŠ¨ï¼Œä½†ä¸åŒçš„æ˜¯æˆ‘ä»¬ä¸è°ƒç”¨ <code>runApp()</code> æ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥åˆ›å»ºä¸€é¢— Render Tree å’Œä½¿ç”¨ Canvasï¼Œé‡‡ç”¨ä¸Šé¢è®²çš„æµç¨‹æ¥æ‰§è¡Œæˆ‘ä»¬çš„ APPã€‚</p><p>æˆ‘ä»¬å…ˆå°è¯•ä½¿ç”¨ Canvas ç»˜åˆ¶ä¸€æ¡ç›´çº¿ï¼Œç„¶åç”Ÿæˆ Picture æ·»åŠ åˆ° Sence ä¸­ï¼Œç„¶åå‘é€ç»™ GPU è¿›è¡Œæ¸²æŸ“ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;dart:ui&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:flutter/material.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> PictureRecorder pictureRecorder <span style=color:#f92672>=</span> PictureRecorder();
</span></span><span style=display:flex><span>  drawLine(pictureRecorder);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Picture picture <span style=color:#f92672>=</span> pictureRecorder.endRecording();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> SceneBuilder sceneBuilder <span style=color:#f92672>=</span> SceneBuilder();
</span></span><span style=display:flex><span>  sceneBuilder.addPicture(Offset.zero, picture);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Scene scene <span style=color:#f92672>=</span> sceneBuilder.build();
</span></span><span style=display:flex><span>  window.render(scene);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> drawLine(PictureRecorder recorder) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Canvas canvas <span style=color:#f92672>=</span> Canvas(recorder);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Paint paint <span style=color:#f92672>=</span> Paint()
</span></span><span style=display:flex><span>    ..color <span style=color:#f92672>=</span> Colors.white
</span></span><span style=display:flex><span>    ..strokeWidth <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  canvas.drawLine(Offset(<span style=color:#ae81ff>300</span>, <span style=color:#ae81ff>300</span>), Offset(<span style=color:#ae81ff>800</span>, <span style=color:#ae81ff>300</span>), paint);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img loading=lazy src=./03.png alt=03.png></p><p>ä¸Šé¢çš„ä»£ç ä¼šåœ¨ç•Œé¢ç»˜åˆ¶ä¸€æ¡ç™½çº¿ï¼Œç”±äºè¿™é‡Œåª render äº†ä¸€æ¬¡ï¼Œå› æ­¤åœ¨ç»˜åˆ¶å®Œè¿™æ¡ç™½çº¿åï¼Œç•Œé¢å°±ä¸ä¼šæœ‰ä»»ä½•å˜åŒ–äº†ã€‚
ç°åœ¨æˆ‘ä»¬å°è¯•è®©çº¿æ¡åŠ¨èµ·æ¥ï¼Œé€šè¿‡ä¸Šé¢çš„è®²è§£ï¼Œæˆ‘ä»¬çŸ¥é“ Flutter æ˜¯ä½¿ç”¨ <code>window.scheduleFrame()</code>æ¥è¯·æ±‚å±å¹•çš„åˆ·æ–°ï¼Œå› æ­¤æˆ‘ä»¬å°†æ¸²æŸ“æ”¾åˆ° <code>window.onDrawFrame</code>ä¸­ï¼Œå¹¶ä¸æ–­æ”¹å˜çº¿æ¡ä½ç½®ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;dart:ui&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:flutter/material.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>double</span> dy <span style=color:#f92672>=</span> <span style=color:#ae81ff>300.0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  window.onDrawFrame <span style=color:#f92672>=</span> () {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> PictureRecorder pictureRecorder <span style=color:#f92672>=</span> PictureRecorder();
</span></span><span style=display:flex><span>    drawLine(pictureRecorder, dy);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (dy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>800</span>)
</span></span><span style=display:flex><span>      dy<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Picture picture <span style=color:#f92672>=</span> pictureRecorder.endRecording();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> SceneBuilder sceneBuilder <span style=color:#f92672>=</span> SceneBuilder();
</span></span><span style=display:flex><span>    sceneBuilder.addPicture(Offset.zero, picture);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Scene scene <span style=color:#f92672>=</span> sceneBuilder.build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¸æ–­åˆ·æ–°ç•Œé¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    window.render(scene);
</span></span><span style=display:flex><span>    window.scheduleFrame();
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  window.scheduleFrame();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> drawLine(PictureRecorder recorder, <span style=color:#66d9ef>double</span> dy) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Canvas canvas <span style=color:#f92672>=</span> Canvas(recorder);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Paint paint <span style=color:#f92672>=</span> Paint()
</span></span><span style=display:flex><span>    ..color <span style=color:#f92672>=</span> Colors.white
</span></span><span style=display:flex><span>    ..strokeWidth <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  canvas.drawLine(Offset(<span style=color:#ae81ff>300</span>, dy), Offset(<span style=color:#ae81ff>800</span>, dy), paint);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ ·å°±å¾—åˆ°äº†ä¸€æ¡ä¼šç§»åŠ¨çš„ç›´çº¿ã€‚</p><p><img loading=lazy src=./04.gif alt=04.gif></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸Šé¢çš„ç›´çº¿å°è£…ä¸ºä¸€ä¸ªè‡ªå®šä¹‰çš„ RenderObjectï¼Œç„¶åè‡ªå·±åˆ›å»ºä¸€é¢— Render Treeï¼Œå¹¶ä½¿ç”¨ <code>drawFrame()</code> æ–¹æ³•ä¸­çš„æµç¨‹ï¼šä½¿ç”¨ <strong>PipelineOwner</strong> æ¥é‡æ–°ç»˜åˆ¶è¢«æ±¡æŸ“çš„èŠ‚ç‚¹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ„å»ºæ ¹èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>final</span> PipelineOwner pipelineOwner <span style=color:#f92672>=</span> PipelineOwner();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> RenderView renderView <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      RenderView(configuration: <span style=color:#66d9ef>const</span> ViewConfiguration(), window: window);
</span></span><span style=display:flex><span>  pipelineOwner.rootNode <span style=color:#f92672>=</span> renderView;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  renderView.prepareInitialFrame();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  renderView.child <span style=color:#f92672>=</span> MyRenderNode();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  window.onDrawFrame <span style=color:#f92672>=</span> () {
</span></span><span style=display:flex><span>    callFlush(pipelineOwner);
</span></span><span style=display:flex><span>    renderView.compositeFrame();
</span></span><span style=display:flex><span>    window.scheduleFrame();
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  window.scheduleFrame();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> callFlush(PipelineOwner pipelineOwner) {
</span></span><span style=display:flex><span>  pipelineOwner.flushLayout();
</span></span><span style=display:flex><span>  pipelineOwner.flushCompositingBits();
</span></span><span style=display:flex><span>  pipelineOwner.flushPaint();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRenderNode</span> <span style=color:#66d9ef>extends</span> RenderBox {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>double</span> _dy <span style=color:#f92672>=</span> <span style=color:#ae81ff>300</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Paint _paint <span style=color:#f92672>=</span> Paint()
</span></span><span style=display:flex><span>    ..color <span style=color:#f92672>=</span> Colors.white
</span></span><span style=display:flex><span>    ..strokeWidth <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> _drawLines(Canvas canvas, <span style=color:#66d9ef>double</span> dy) {
</span></span><span style=display:flex><span>    canvas.drawLine(Offset(<span style=color:#ae81ff>300</span>, dy), Offset(<span style=color:#ae81ff>800</span>, dy), _paint);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> paint(PaintingContext context, Offset offset) {
</span></span><span style=display:flex><span>    _drawLines(context.canvas, _dy);
</span></span><span style=display:flex><span>    _dy<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    markNeedsLayout();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ä»½ä»£ç è¿è¡Œçš„æ•ˆæœå’Œä¸Šé¢çš„æ˜¯ä¸€æ ·çš„ï¼Œä½†åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¹¶ä¸èƒ½çœ‹å‡ºè½¬åŒ–ä¸º Layer Tree çš„ä¼˜åŠ¿ï¼Œæˆ‘ä»¬æ¥æ„å»ºä¸€é¢—å¤šä¸ªèŠ‚ç‚¹çš„ Render Treeã€‚æˆ‘ä»¬é‡‡ç”¨ <strong>RenderFlex</strong> æ¥å­˜å‚¨å¤šä¸ªèŠ‚ç‚¹ï¼Œå¹¶å’Œä¸Šé¢è®²è§£ <code>flushLayout()</code>æ—¶æ‰€è¯´çš„ä¸€æ ·äº¤ç”±çˆ¶èŠ‚ç‚¹æ¥å†³å®šå¸ƒå±€å¤§å°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ„å»ºæ ¹èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>final</span> PipelineOwner pipelineOwner <span style=color:#f92672>=</span> PipelineOwner();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> RenderView renderView <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      RenderView(configuration: <span style=color:#66d9ef>const</span> ViewConfiguration(), window: window);
</span></span><span style=display:flex><span>  pipelineOwner.rootNode <span style=color:#f92672>=</span> renderView;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  renderView.prepareInitialFrame();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> RenderFlex flex <span style=color:#f92672>=</span> RenderFlex(textDirection: TextDirection.ltr);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ä» 301 å¼€å§‹ç§»åŠ¨åˆ° 500 ä¸€å…±ç»˜åˆ¶äº† 200 æ¬¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>double</span> dy <span style=color:#f92672>=</span> <span style=color:#ae81ff>301</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ›å»ºä¸¤ä¸ªå¶å­èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>final</span> MyRenderNode node1 <span style=color:#f92672>=</span> MyRenderNode(dy, Colors.white);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> MyRenderNode node2 <span style=color:#f92672>=</span> MyRenderNode(dy, Colors.blue);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  renderView.child <span style=color:#f92672>=</span> flex;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ³¨æ„è¿™é‡Œæ˜¯å¾€å‰æ’å…¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  flex.insert(node1);
</span></span><span style=display:flex><span>  flex.insert(node2);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  window.onDrawFrame <span style=color:#f92672>=</span> () {
</span></span><span style=display:flex><span>    callFlush(pipelineOwner);
</span></span><span style=display:flex><span>    renderView.compositeFrame();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (dy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>500</span>) {
</span></span><span style=display:flex><span>      node1.dy <span style=color:#f92672>=</span> <span style=color:#f92672>++</span>dy;
</span></span><span style=display:flex><span>      window.scheduleFrame();
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#39;node1 paint count: </span><span style=color:#e6db74>${</span>node1.paintCount<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>);
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#39;node2 paint count: </span><span style=color:#e6db74>${</span>node2.paintCount<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  window.scheduleFrame();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> callFlush(PipelineOwner pipelineOwner) {
</span></span><span style=display:flex><span>  pipelineOwner.flushLayout();
</span></span><span style=display:flex><span>  pipelineOwner.flushCompositingBits();
</span></span><span style=display:flex><span>  pipelineOwner.flushPaint();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRenderNode</span> <span style=color:#66d9ef>extends</span> RenderBox {
</span></span><span style=display:flex><span>  MyRenderNode(<span style=color:#66d9ef>this</span>._dy, Color color) {
</span></span><span style=display:flex><span>    _paint <span style=color:#f92672>=</span> Paint()
</span></span><span style=display:flex><span>      ..color <span style=color:#f92672>=</span> color
</span></span><span style=display:flex><span>      ..strokeWidth <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>double</span> _dy;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> paintCount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>set</span> dy(<span style=color:#66d9ef>double</span> dy) {
</span></span><span style=display:flex><span>    _dy <span style=color:#f92672>=</span> dy;
</span></span><span style=display:flex><span>    markNeedsLayout();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>double</span> <span style=color:#66d9ef>get</span> dy <span style=color:#f92672>=&gt;</span> _dy;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  late Paint _paint;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> _drawLines(Canvas canvas, <span style=color:#66d9ef>double</span> dy) {
</span></span><span style=display:flex><span>    canvas.drawLine(Offset(<span style=color:#ae81ff>300</span>, dy), Offset(<span style=color:#ae81ff>800</span>, dy), _paint);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> paint(PaintingContext context, Offset offset) {
</span></span><span style=display:flex><span>    _drawLines(context.canvas, dy);
</span></span><span style=display:flex><span>    paintCount<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>get</span> sizedByParent <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  Size computeDryLayout(BoxConstraints constraints) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> constraints.smallest;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ä»½ä»£ç æ¯”è¾ƒé•¿ï¼Œå¯¹äº <code>MyRenderNode</code>çš„ä¿®æ”¹ï¼š</p><ul><li>é¦–å…ˆæˆ‘ä»¬é‡å†™äº† <code>sizedByParent</code>å’Œ <code>computeDryLayout()</code>ï¼Œç”¨äºåœ¨å¸ƒå±€æµ‹é‡æ—¶å†³å®šå¤§å°</li><li><code>_dy</code> å±æ€§æ·»åŠ äº† setter æ–¹æ³•ï¼Œåœ¨æ¯æ¬¡ä¿®æ”¹ <code>_dy</code> çš„å€¼æ—¶è°ƒç”¨ <code>markNeedsLayout()</code> æ¥è®©ä¸‹ä¸€æ¬¡ç•Œé¢åˆ·æ–°æ—¶é‡æ–°ç»˜åˆ¶èŠ‚ç‚¹</li><li>å¦å¤–æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ª <code>piantCount</code> å±æ€§æ¥è®°å½•èŠ‚ç‚¹ç»˜åˆ¶äº†å‡ æ¬¡</li></ul><p>æ¥ç€æ˜¯ main æ–¹æ³•ä¸­ï¼š</p><ul><li>ä½¿ç”¨ RenderFlex ä½œä¸º RenderView çš„å­èŠ‚ç‚¹</li><li>åˆ›å»ºäº†ä¸¤ä¸ªå­èŠ‚ç‚¹æ’å…¥åˆ° RenderFlex ä¸­</li><li>æ¯æ¬¡æ¸²æŸ“æ—¶ï¼Œéƒ½ä¼šä¿®æ”¹ node1 çš„ dyï¼Œè®©ä»–è¿›è¡Œé‡ç»˜ï¼Œnode2 åˆ™ä¸åšä¿®æ”¹</li><li>å½“ dy çš„å€¼è¾¾åˆ°äº† 500 çš„æ—¶å€™åœæ­¢ç•Œé¢åˆ·æ–°å¹¶æ‰“å°ä¸¤ä¸ªèŠ‚ç‚¹çš„ç»˜åˆ¶æ¬¡æ•°</li></ul><p><img loading=lazy src=./05.gif alt=05.gif></p><p>æ•ˆæœå¦‚ä¸Šï¼Œä¼šæœ‰ä¸€æ ¹ä¸åŠ¨çš„è“çº¿ï¼Œå’Œä¸€æ ¹ç§»åŠ¨çš„ç™½çº¿ã€‚
æˆ‘ä»¬å†çœ‹çœ‹æ§åˆ¶å°æ‰“å°çš„ä¿¡æ¯ã€‚</p><p><img loading=lazy src=./06.png alt=06.png></p><p>æˆ‘ä»¬å‘ç°ä¸¤ä¸ªèŠ‚ç‚¹çš„ç»˜åˆ¶æ¬¡æ•°éƒ½æ˜¯ 200ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡æ¸²æŸ“ä¸¤ä¸ªèŠ‚ç‚¹éƒ½è¿›è¡Œäº†é‡æ–°ç»˜åˆ¶ï¼Œæ ¹æ®ä¸Šé¢æˆ‘ä»¬è®²åˆ°çš„ PaintingContext å’Œ Layer çš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«åˆ¤æ–­å‡ºï¼Œè¿™æ˜¯ç”±äº node1 å’Œ node2 æ²¡æœ‰åˆ†å¼€ç»˜åˆ¶ï¼Œä½¿ç”¨åŒä¸€ä¸ª Layer èŠ‚ç‚¹æ‰€é€ æˆçš„ã€‚</p><p>ç”±äº node1 è¢«æ±¡æŸ“åä¹Ÿä¼šè°ƒç”¨çˆ¶èŠ‚ç‚¹ flex çš„ <code>markNeedsPaint()</code>ï¼Œå› æ­¤ç»˜åˆ¶æ“ä½œæ—¶ç”±çˆ¶èŠ‚ç‚¹å‘ä¸‹ç»˜åˆ¶çš„ï¼Œè€Œ node2 ä¹Ÿæ˜¯ flex çš„å­èŠ‚ç‚¹ï¼Œæ•´æ£µå­æ ‘éƒ½ä¼šé‡æ–°ç»˜åˆ¶ï¼Œè¿™å°±æ˜¯ node2 æ±¡æŸ“æ—¶ node1 ä¹Ÿè·Ÿç€é‡ç»˜çš„åŸå› ã€‚
â€‹</p><p>æˆ‘ä»¬åœ¨è‡ªå®šä¹‰çš„ RenderBox é‡Œé‡å†™ <strong>isRepaintBoundary</strong> å±æ€§ï¼Œå¹¶åœ¨ framework å±‚ä¸º <strong>ContainerLayer</strong> æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹è®¡æ•°æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// ContainerLayer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> layerCount() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// ç®—ä¸Šå½“å‰èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Layer<span style=color:#f92672>?</span> child <span style=color:#f92672>=</span> firstChild;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (child <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(child <span style=color:#66d9ef>is</span> OffsetLayer)
</span></span><span style=display:flex><span>      count <span style=color:#f92672>+=</span> child.layerCount();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    child <span style=color:#f92672>=</span> child.nextSibling;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> count;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>void</span> main() {
</span></span><span style=display:flex><span>  window.onDrawFrame <span style=color:#f92672>=</span> () {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (dy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>500</span>) {
</span></span><span style=display:flex><span>      node1.dy <span style=color:#f92672>=</span> <span style=color:#f92672>++</span>dy;
</span></span><span style=display:flex><span>      window.scheduleFrame();
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#39;node1 paint count: </span><span style=color:#e6db74>${</span>node1.paintCount<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>);
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#39;node2 paint count: </span><span style=color:#e6db74>${</span>node2.paintCount<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// åœ¨ç»“æŸæ—¶æ‰“å° Layer çš„æ•°é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      print(<span style=color:#e6db74>&#39;layer count: </span><span style=color:#e6db74>${</span>renderView.layer<span style=color:#f92672>?</span>.layerCount()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyRenderNode</span> <span style=color:#66d9ef>extends</span> RenderBox {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> _isRepaintBoundary <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>get</span> isRepaintBoundary <span style=color:#f92672>=&gt;</span> _isRepaintBoundary;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/// æ·»åŠ è®¾ç½®æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>set</span> isRepaintBoundary(<span style=color:#66d9ef>bool</span> v) {
</span></span><span style=display:flex><span>    _isRepaintBoundary <span style=color:#f92672>=</span> v;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬å…ˆæ¥æ¼”ç¤ºä¸¤ç§æƒ…å†µï¼š</p><ol><li>ä¸å¯¹ä¸¤ä¸ªå¶å­èŠ‚ç‚¹çš„ isRepaintBoundary è¿›è¡Œä¿®æ”¹</li></ol><p><img loading=lazy src=./07.png alt=07.png></p><ol><li>å°† node1 å•ç‹¬ç»˜åˆ¶ï¼š<code>node1.isRepaintBoundary = false;</code></li></ol><p><img loading=lazy src=./08.png alt=08.png></p><p>å¯ä»¥çœ‹åˆ° node1 çš„ isRepaintBoundary è®¾ç½®ä¸º true æ—¶ï¼Œ node2 åªç»˜åˆ¶äº† 1 æ¬¡ï¼Œç°åœ¨ node2 çš„æ±¡æŸ“å°±ä¸ä¼šå¯¼è‡´ node1 é‡ç»˜åˆ¶äº†ã€‚</p><p>å¦å¤–æˆ‘ä»¬çœ‹åˆ°ç¬¬äºŒç§æƒ…å†µçš„ Layer èŠ‚ç‚¹æ•°é‡åˆ†æ˜¯ 4ï¼Œä¸ºä»€ä¹ˆä¼šæ˜¯ 4 å‘¢ï¼Ÿ</p><p>å›æƒ³ä¸€ä¸‹ä»‹ç» PaintingContext åˆ›å»ºæ—¶æä¾› Layout çš„è¦æ±‚ï¼š</p><blockquote><p>å½“æä¾›ç»™ PaintingContext çš„ Layer èŠ‚ç‚¹ä¸å±äº OffsetLayer æ—¶ ï¼Œä¼šåˆ›å»ºä¸€ä¸ª OffsetLayer æ¥ä»£æ›¿åŸæœ¬çš„ Layerï¼Œä½œä¸ºå½“å‰å­æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚</p></blockquote><p>å¦‚æœæˆ‘ä»¬å¯¹ç¨‹åºè¿›è¡Œè°ƒè¯•ï¼Œå°±å¯ä»¥å‘ç°ï¼Œè™½ç„¶æ˜¯ä»¥ node1ã€node2 çš„é¡ºåºæ’å…¥ï¼Œä½†å®é™… <code>insert()</code> æ–¹æ³•æ˜¯å¾€å‰æ’å…¥ï¼Œåœ¨ flex ä¸­ node2 æ˜¯å¤„äº node1 çš„å‰é¢ï¼Œå› æ­¤ node2 ä¼šå…ˆè¿›è¡Œç»˜åˆ¶ã€‚</p><p>ç”±äº node2 å¹¶æ²¡æœ‰è®¾ç½®å•ç‹¬ç»˜åˆ¶ï¼Œå› æ­¤ä¼šæŒ‰ç…§æ­£å¸¸æµç¨‹å’Œ flex ç»˜åˆ¶åœ¨åŒä¸€ä¸ª PictureRecorder ä¸­ç”Ÿæˆä¸€ä¸ª PictureLayer å¹¶æ·»åŠ åˆ° TransformLayer ä¸­ã€‚</p><p>node2 ç»˜åˆ¶å®Œæˆä¹‹åå¼€å§‹ç»˜åˆ¶ node1ã€‚ç”±äºæˆ‘ä»¬å°† node1 è®¾ç½®ä¸ºå•ç‹¬ç»˜åˆ¶ï¼Œé‚£ä¹ˆç»˜åˆ¶ node1 çš„æ—¶å€™å°†ä¼šä½œä¸ºä¸€ä¸ªå­æ ‘é‡æ–°å¼€å§‹ç»˜åˆ¶ï¼Œè¿™æ—¶ä¼šé‡æ–°è°ƒç”¨ <code>_repaintCompositedChild()</code>æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª<strong>æ–°çš„ PaintingContext</strong> æ¥ä¼ é€’ï¼Œæ­¤æ—¶ç”±äº node1 æ˜¯ä¸€ä¸ªå¶å­ç»“ç‚¹ï¼Œæœ¬èº«å¹¶ä¸é™„å¸¦ OffsetLayer èŠ‚ç‚¹ï¼Œ<strong>å› æ­¤ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ OffsetLayer ç»™ PaintingConext</strong>ï¼Œå†è¿›è¡Œç»˜åˆ¶ã€‚</p><p><strong>ç»˜åˆ¶ node 1 æ—¶ç”Ÿæˆçš„ PictureLayer æ·»åŠ åˆ°è¿™ä¸ª OffsetLayout ä¸­ï¼Œå®Œæˆç»˜åˆ¶ä¹‹åå†å°† OffsetLayout æ·»åŠ åˆ° RenderView çš„ TransformLayer ä¸­ã€‚</strong></p><p>å› æ­¤ç¬¬ 2 ç§æƒ…å†µä¼šå¾—åˆ° 4 ä¸ª Layer èŠ‚ç‚¹ï¼Œå¯¹åº”çš„ Layer å›¾ç¤ºå¦‚ä¸‹ï¼š</p><p><img loading=lazy src=./yuque_diagram_2.jpg alt=yuque_diagram_2></p><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹è®¡æ•°æ–¹æ³•ï¼Œè®©å®ƒæ‰“å°å½“å‰éå†çš„å±‚æ¬¡å’ŒèŠ‚ç‚¹ç±»å‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>int</span> layerCount() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> deep <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  print(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>$</span>deep<span style=color:#e6db74> ==&gt; root is [</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.runtimeType<span style=color:#e6db74>}</span><span style=color:#e6db74>]&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> _layerCount(deep <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> _layerCount(<span style=color:#66d9ef>int</span> deep) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// ç®—ä¸Šå½“å‰èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Layer<span style=color:#f92672>?</span> child <span style=color:#f92672>=</span> firstChild;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (child <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>$</span>deep<span style=color:#e6db74> ==&gt; child is [</span><span style=color:#e6db74>${</span>child.runtimeType<span style=color:#e6db74>}</span><span style=color:#e6db74>]&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(child <span style=color:#66d9ef>is</span> OffsetLayer)
</span></span><span style=display:flex><span>      count <span style=color:#f92672>+=</span> child._layerCount(deep <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    child <span style=color:#f92672>=</span> child.nextSibling;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> count;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img loading=lazy src=./09.png alt=09.png></p><p>å¯ä»¥çœ‹åˆ°å’Œæˆ‘ä»¬ç”»çš„è½¬åŒ–å›¾æ˜¯ä¸€æ ·çš„ã€‚å¦‚æœæˆ‘ä»¬å°† node1 å’Œ node2 äº¤æ¢ä¸€ä¸‹ï¼Œå…ˆæ·»åŠ  node2 å†æ·»åŠ  node1ï¼Œä½¿ node1 å…ˆè¿›è¡Œç»˜åˆ¶ï¼Œé‚£ä¹ˆç»“æœä¼šæ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>flex.insert(node2);
</span></span><span style=display:flex><span>flex.insert(node1);
</span></span></code></pre></div><p><img loading=lazy src=./10.png alt=10.png></p><p>å¯ä»¥çœ‹åˆ°ä¾æ—§æ˜¯ 4 ä¸ª Layer èŠ‚ç‚¹ï¼Œnode2 ç”Ÿæˆçš„ PictureLayer ä¾æ—§æ˜¯ TransformLayer çš„å­èŠ‚ç‚¹ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ RenderFlex æ˜¯å¦‚ä½•ç»˜åˆ¶å­èŠ‚ç‚¹çš„ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒè¯•è¿›å…¥ RenderFlex çš„ <code>paint()</code> æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨çš„æ˜¯ <code>paintDefault()</code>ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œéå†ä¾æ¬¡è°ƒç”¨<strong>å½“å‰ PaintingContext</strong> çš„ <code>paintChild()</code> ç»˜åˆ¶å­èŠ‚ç‚¹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>void</span> defaultPaint(PaintingContext context, Offset offset) {
</span></span><span style=display:flex><span>  ChildType<span style=color:#f92672>?</span> child <span style=color:#f92672>=</span> firstChild;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// éå†å­èŠ‚ç‚¹è¿›è¡Œç»˜åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>while</span> (child <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ParentDataType childParentData <span style=color:#f92672>=</span> child.parentData<span style=color:#f92672>!</span> <span style=color:#f92672>as</span> ParentDataType;
</span></span><span style=display:flex><span>    context.paintChild(child, childParentData.offset <span style=color:#f92672>+</span> offset);
</span></span><span style=display:flex><span>    child <span style=color:#f92672>=</span> childParentData.nextSibling;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>RenderFlex å¾ªç¯ç»˜åˆ¶æ—¶ï¼Œçˆ¶èŠ‚ç‚¹å’Œä¸‹é¢çš„å­èŠ‚ç‚¹ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ª PaintingContexã€‚ç”±äº node1 æ˜¯å•ç‹¬ç»˜åˆ¶ï¼Œå› æ­¤ä¼šåˆ›å»ºä¸€ä¸ª<strong>æ–°çš„ PaintingContext å’Œ OffsetLayer</strong>ï¼Œä½†ç»˜åˆ¶ node2 æ—¶è¿˜æ˜¯ä½¿ç”¨<strong>çˆ¶èŠ‚ç‚¹çš„ PaintingContext</strong>ï¼Œæ‰€ä»¥ flex å’Œ node2 ä¼šä¸€èµ·ç”Ÿæˆä¸€ä¸ª PictureLayer æ·»åŠ åˆ°æ ¹èŠ‚ç‚¹ä¸­ã€‚</p><h2 id=ç»“è¯­>ç»“è¯­<a hidden class=anchor aria-hidden=true href=#ç»“è¯­>#</a></h2><p>æœ¬æ–‡åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥çœ‹åˆ°ï¼ŒFlutter æ€§èƒ½é«˜çš„ä¸€ä¸ªå¾ˆé‡è¦çš„åŸå› ï¼Œå°±æ˜¯å®ƒåœ¨èµ„æºå¤ç”¨å’Œé¿å…ä¸å¿…è¦è®¡ç®—ç­‰æ–¹é¢ï¼Œåšäº†å¾ˆå¤šæ€è€ƒã€‚</p><p>ä¹‹æ‰€ä»¥ç ”ç©¶è¿™éƒ¨åˆ†ï¼Œæ˜¯å› ä¸ºè¿™éƒ¨åˆ†æ˜¯ Flutter Framework å±‚æœ€è´´è¿‘ Engine å±‚çš„å†…å®¹ï¼Œå¯¹ä»¥åç ”ç©¶ Flutter å’Œ Android ä¸¤è€…åœ¨ Engine å±‚çš„å¼‚åŒç‚¹ä¼šæœ‰å¾ˆå¤§å¸®åŠ©ã€‚</p><p>ç”±äºæ¶‰åŠåˆ°çš„ä¸œè¥¿ç‰¹åˆ«å¤šï¼Œå› æ­¤å¹¶æ²¡åŠæ³•è®²çš„å¾ˆå…¨é¢ï¼Œæœ¬æ–‡æ‰€è¦ä»‹ç»çš„å†…å®¹ä¹Ÿå¯èƒ½å­˜åœ¨é—æ¼ï¼Œä½†æŒ‰ç…§æœ¬æ–‡è®²è§£çš„æµç¨‹å»é˜…è¯»æºç è¿›è¡Œæ‰©å±•ï¼Œå¹¶ä¸éš¾å¼„æ‡‚ï¼Œæœ‰é—®é¢˜å¯åœ¨è¯„è®ºåŒºç•™è¨€ã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://answerkobe.github.io/tags/flutter/>Flutter</a></li><li><a href=http://answerkobe.github.io/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=http://answerkobe.github.io/posts/jetpack-compose-explore/><span class=title>Â« Prev</span><br><span>Jetpack Compose æ¢ç´¢</span>
</a><a class=next href=http://answerkobe.github.io/posts/explore-the-kotlin-generics/><span class=title>Next Â»</span><br><span>æ¢ç´¢ Java & Kotlin æ³›å‹</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ on x" href="https://x.com/intent/tweet/?text=Flutter%20%e7%bb%98%e5%88%b6%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90%e4%b8%8e%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5&amp;url=http%3a%2f%2fanswerkobe.github.io%2fposts%2fanalysis-flutter-paint-process%2f&amp;hashtags=Flutter%2cAndroid"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2fanswerkobe.github.io%2fposts%2fanalysis-flutter-paint-process%2f&amp;title=Flutter%20%e7%bb%98%e5%88%b6%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90%e4%b8%8e%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5&amp;summary=Flutter%20%e7%bb%98%e5%88%b6%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90%e4%b8%8e%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5&amp;source=http%3a%2f%2fanswerkobe.github.io%2fposts%2fanalysis-flutter-paint-process%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ on reddit" href="https://reddit.com/submit?url=http%3a%2f%2fanswerkobe.github.io%2fposts%2fanalysis-flutter-paint-process%2f&title=Flutter%20%e7%bb%98%e5%88%b6%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90%e4%b8%8e%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fanswerkobe.github.io%2fposts%2fanalysis-flutter-paint-process%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ on whatsapp" href="https://api.whatsapp.com/send?text=Flutter%20%e7%bb%98%e5%88%b6%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90%e4%b8%8e%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5%20-%20http%3a%2f%2fanswerkobe.github.io%2fposts%2fanalysis-flutter-paint-process%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ on telegram" href="https://telegram.me/share/url?text=Flutter%20%e7%bb%98%e5%88%b6%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90%e4%b8%8e%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5&amp;url=http%3a%2f%2fanswerkobe.github.io%2fposts%2fanalysis-flutter-paint-process%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Flutter ç»˜åˆ¶æµç¨‹åˆ†æä¸ä»£ç å®è·µ on ycombinator" href="https://news.ycombinator.com/submitlink?t=Flutter%20%e7%bb%98%e5%88%b6%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90%e4%b8%8e%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5&u=http%3a%2f%2fanswerkobe.github.io%2fposts%2fanalysis-flutter-paint-process%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script id=utteranc src=https://utteranc.es/client.js repo=Answerkobe/utterances issue-term=pathname theme=github-light crossorigin=anonymous async></script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.body.className.includes("dark")?"github-light":"photon-dark",t={type:"set-theme",theme:e},n=document.querySelector(".utterances-frame");n.contentWindow.postMessage(t,"https://utteranc.es")})</script></article></main><footer class=footer><span>&copy; 2023 <a href=http://answerkobe.github.io/>Iverson's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>